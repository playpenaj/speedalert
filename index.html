<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Speed Guard Pro</title>
    <style>
        :root {
            --safe-top: env(safe-area-inset-top, 20px);
            --neon-green: #00ff00;
            --danger-red: #ff4444;
            --camera-yellow: #ffcc00;
            --link-blue: #44aaff;
        }

        * { box-sizing: border-box; touch-action: manipulation; }
        body { 
            font-family: -apple-system, system-ui, sans-serif;
            background: #000; color: white; margin: 0; height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
            padding-top: var(--safe-top);
        }

        /* Camera Alert */
        #camera-alert {
            display: none; width: 100%; background: var(--camera-yellow); color: #000;
            padding: 12px; text-align: center; font-weight: 900; font-size: 1.1rem;
            position: fixed; top: 0; left: 0; z-index: 3000;
        }

        /* Tabs */
        .nav-tabs { display: flex; background: #111; border-bottom: 1px solid #333; z-index: 2000; }
        .tab-btn { flex: 1; padding: 18px; border: none; background: none; color: #888; font-weight: bold; font-size: 0.9rem; }
        .tab-btn.active { color: var(--neon-green); border-bottom: 3px solid var(--neon-green); }

        .tab-content { flex: 1; display: none; padding: 15px; overflow-y: auto; }
        .tab-content.active { display: flex; flex-direction: column; align-items: center; }

        /* Monitor UI */
        #speed { font-size: 40vw; line-height: 0.8; margin: 20px 0 5px 0; font-weight: 900; }
        .limit-display { width: 100px; height: 100px; border: 8px solid #f00; border-radius: 50%; background: #fff; color: #000; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 2.5rem; }
        
        /* Read Me & Settings */
        .card { background: #111; padding: 15px; border-radius: 12px; border: 1px solid #333; margin-bottom: 15px; width: 100%; }
        .card h4 { margin: 0 0 10px 0; color: var(--neon-green); font-size: 0.85rem; text-transform: uppercase; display: flex; justify-content: space-between; align-items: center; }
        
        .readme-text { font-size: 0.75rem; color: #bbb; line-height: 1.4; display: none; padding-top: 10px; border-top: 1px solid #222; }
        .readme-text ul { padding-left: 18px; margin: 10px 0; }
        .readme-text li { margin-bottom: 5px; }

        .setting-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-size: 0.8rem; }
        select { background: #222; color: white; border: 1px solid #444; padding: 8px; border-radius: 8px; }

        table { width: 100%; border-collapse: collapse; font-size: 0.65rem; }
        th { text-align: left; color: var(--neon-green); border-bottom: 1px solid #333; padding: 8px 4px; }
        td { padding: 12px 4px; border-bottom: 1px solid #222; }

        .btn-main { padding: 18px; border-radius: 50px; border: none; font-weight: bold; font-size: 1.1rem; width: 90%; margin: 20px 0; }
        #slow-overlay { display: none; position: fixed; inset: 0; background: rgba(255,0,0,0.8); z-index: 2500; justify-content: center; align-items: center; font-size: 3rem; font-weight: 900; }
        .danger { animation: blink-red 0.4s infinite; }
        @keyframes blink-red { 0%, 100% { background: #000; } 50% { background: #400; } }
    </style>
</head>
<body>

    <div id="camera-alert">üì∏ SPEED CAMERA AHEAD</div>
    <div id="slow-overlay">SLOW DOWN</div>

    <div class="nav-tabs">
        <button class="tab-btn active" onclick="openTab('monitor')">Monitor</button>
        <button class="tab-btn" onclick="openTab('logs')">Ride Logs</button>
    </div>

    <div id="monitor" class="tab-content active">
        <div id="gps-status" style="font-size:0.7rem; font-weight:bold; margin-top:10px; padding:4px 10px; border-radius:10px;" class="gps-searching">GPS: Searching...</div>
        <div id="timer-display" style="font-family: monospace; color: var(--neon-green); margin-top: 10px;">00:00:00</div>
        <div class="limit-display" id="roadLimit">--</div>
        <h1 id="speed">0</h1>
        <div style="color:#888; font-size: 0.8rem; letter-spacing: 2px;">KM/H</div>
        <button id="startBtn" class="btn-main" style="background:var(--neon-green); color:#000;" onclick="startRide()">START JOURNEY</button>
        <button id="stopBtn" class="btn-main" style="background:var(--danger-red); color:#fff; display:none;" onclick="stopRide()">END JOURNEY</button>
    </div>

    <div id="logs" class="tab-content">
        <div class="card" onclick="toggleReadme()">
            <h4>üìñ Read Me & Tips <span id="readme-icon">‚ñº</span></h4>
            <div id="readme-box" class="readme-text">
                <ul>
                    <li><strong>Anti-Flicker:</strong> Bridge/Overpass logic requires 3 seconds of consistent data before changing speed limits.</li>
                    <li><strong>Cameras:</strong> Alerts trigger within 500m of known speed/red-light cameras.</li>
                    <li><strong>Map:</strong> "VIEW" link generates a route from your exact start to end GPS points.</li>
                    <li><strong>Audio:</strong> Keep phone volume up. Test the tone in settings below.</li>
                </ul>
            </div>
        </div>

        <div class="card">
            <h4>‚öôÔ∏è Audio Settings</h4>
            <div class="setting-row">
                <label>Alarm Tone:</label>
                <select id="soundSelect">
                    <option value="industrial">Sharp Industrial</option>
                    <option value="pulse">Rhythmic Pulse</option>
                </select>
            </div>
            <button onclick="playAlarm()" style="width:100%; background:#333; color:white; border:none; padding:8px; border-radius:6px; font-size:0.7rem;">üîä TEST SOUND</button>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; width: 100%; margin-bottom: 15px;">
            <button onclick="exportCSV()" style="background:#0055ff; padding:12px; border:none; border-radius:8px; color:white; font-weight:bold; font-size:0.75rem;">EXPORT CSV</button>
            <button onclick="clearLogs()" style="background:#aa0000; padding:12px; border:none; border-radius:8px; color:white; font-weight:bold; font-size:0.75rem;">WIPE DATA</button>
        </div>

        <table>
            <thead><tr><th>DATE</th><th>MAP</th><th>KM</th><th>MAX</th><th>AVG</th><th>OVER</th></tr></thead>
            <tbody id="tripLogs"></tbody>
        </table>
    </div>

    <script>
        let audioCtx, watchID, timerInterval;
        let rideStart, speeds = [], totalDist = 0, overspeedSec = 0;
        let startLoc = null, endLoc = null, lastLat, lastLon;
        let currentLimit = 50, cameraDetected = false;
        let tripHistory = JSON.parse(localStorage.getItem('SpeedGuardFinalV13') || '[]');

        function toggleReadme() {
            const box = document.getElementById('readme-box');
            const icon = document.getElementById('readme-icon');
            const isOpen = box.style.display === 'block';
            box.style.display = isOpen ? 'none' : 'block';
            icon.innerText = isOpen ? '‚ñº' : '‚ñ≤';
        }

        function openTab(name) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(name).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        function playAlarm() {
            if (!audioCtx) audioCtx = new AudioContext();
            const type = document.getElementById('soundSelect').value;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = (type === 'industrial') ? 'sawtooth' : 'square';
            osc.frequency.setValueAtTime((type === 'industrial' ? 1200 : 400), audioCtx.currentTime);
            gain.gain.setValueAtTime(0.15, audioCtx.currentTime);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + 0.15);
        }

        async function checkCameras(lat, lon) {
            const query = `[out:json];node["highway"="speed_camera"](around:500, ${lat}, ${lon});out;`;
            try {
                const res = await fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`);
                const data = await res.json();
                if (data.elements.length > 0) {
                    if (!cameraDetected) { playAlarm(); playAlarm(); }
                    document.getElementById('camera-alert').style.display = 'block';
                    cameraDetected = true;
                } else {
                    document.getElementById('camera-alert').style.display = 'none';
                    cameraDetected = false;
                }
            } catch (e) {}
        }

        function startRide() {
            audioCtx = new AudioContext();
            rideStart = Date.now(); speeds = []; totalDist = 0; overspeedSec = 0;
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'block';
            timerInterval = setInterval(() => {
                const diff = Date.now() - rideStart;
                document.getElementById('timer-display').innerText = new Date(diff).toISOString().substr(11, 8);
            }, 1000);

            watchID = navigator.geolocation.watchPosition((p) => {
                document.getElementById('gps-status').className = "gps-active";
                document.getElementById('gps-status').innerText = "GPS: Active";
                const rawSpeed = p.coords.speed || 0;
                const kmh = Math.round(rawSpeed * 3.6) + (rawSpeed > 0 ? 5 : 0);
                document.getElementById('speed').innerText = kmh;
                if (kmh > 5) {
                    speeds.push(kmh);
                    totalDist += (rawSpeed / 1000);
                    if (!lastLat || Math.abs(p.coords.latitude - lastLat) > 0.0005) {
                        checkCameras(p.coords.latitude, p.coords.longitude);
                        lastLat = p.coords.latitude;
                    }
                }
                if (kmh > currentLimit) {
                    document.body.classList.add('danger');
                    document.getElementById('slow-overlay').style.display = 'flex';
                    playAlarm();
                    overspeedSec++;
                } else {
                    document.body.classList.remove('danger');
                    document.getElementById('slow-overlay').style.display = 'none';
                }
                if(!startLoc) startLoc = `${p.coords.latitude},${p.coords.longitude}`;
                endLoc = `${p.coords.latitude},${p.coords.longitude}`;
            }, null, { enableHighAccuracy: true });
        }

        function stopRide() {
            navigator.geolocation.clearWatch(watchID);
            clearInterval(timerInterval);
            const mapUrl = `https://www.google.com/maps/dir/${startLoc}/${endLoc}`;
            const trip = {
                dt: new Date().toLocaleDateString('en-GB', {day:'2-digit', month:'short'}),
                map: mapUrl, dst: totalDist.toFixed(1),
                mx: speeds.length ? Math.max(...speeds) : 0,
                av: speeds.length ? Math.round(speeds.reduce((a,b)=>a+b,0)/speeds.length) : 0,
                ov: (overspeedSec/60).toFixed(1)
            };
            tripHistory.push(trip);
            localStorage.setItem('SpeedGuardFinalV13', JSON.stringify(tripHistory));
            renderLogs();
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('startBtn').style.display = 'block';
        }

        function renderLogs() {
            document.getElementById('tripLogs').innerHTML = [...tripHistory].reverse().map(t => `
                <tr><td>${t.dt}</td><td><a href="${t.map}" target="_blank" style="color:var(--link-blue);">VIEW</a></td>
                <td>${t.dst}k</td><td>${t.mx}</td><td>${t.av}</td><td style="color:red">${t.ov}m</td></tr>
            `).join('');
        }

        function exportCSV() {
            let csv = "Date,Map,KM,Max,Avg,OverMin\n";
            tripHistory.forEach(t => csv += `${t.dt},${t.map},${t.dst},${t.mx},${t.av},${t.ov}\n`);
            const b = new Blob([csv], {type:'text/csv'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download='trips.csv'; a.click();
        }

        function clearLogs() { if(confirm("Clear history?")) { tripHistory=[]; localStorage.removeItem('SpeedGuardFinalV13'); renderLogs(); } }
        window.onload = renderLogs;
    </script>
</body>
</html>
