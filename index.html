<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Speed Guard Pro</title>

<style>
:root{--green:#00ff00;--red:#ff4444;--bg:#000;--card:#111}
*{box-sizing:border-box}
body{
 margin:0;background:var(--bg);color:#fff;
 font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto;
 height:100vh;display:flex;flex-direction:column
}

/* MODAL */
#modal{
 position:fixed;inset:0;background:rgba(0,0,0,.9);
 display:none;z-index:9999;
 align-items:center;justify-content:center;padding:20px
}
#modalBox{
 background:#111;border-radius:20px;
 padding:22px;max-width:340px;width:100%;
 border:1px solid #333
}
#modalBox h3{margin-top:0;color:var(--green)}
#modalBox p{font-size:.85rem;color:#ccc;line-height:1.5}
#modalBox button{
 margin-top:15px;width:100%;
 padding:12px;border:none;
 border-radius:12px;font-weight:900;
 background:var(--green);color:#000
}

/* NAV */
.nav-tabs{display:flex;background:#111;border-bottom:1px solid #222}
.tab-btn{
 flex:1;padding:18px;border:none;background:none;
 color:#666;font-weight:900
}
.tab-btn.active{color:var(--green);border-bottom:3px solid var(--green)}
.tab-content{flex:1;display:none;flex-direction:column;align-items:center;padding:10px}
.tab-content.active{display:flex}

/* DASH */
.dash-grid{
 display:grid;grid-template-columns:repeat(3,1fr);
 gap:6px;width:100%
}
.dash-item{
 background:var(--card);border-radius:12px;
 padding:10px;text-align:center;border:1px solid #222
}
.dash-label{font-size:.55rem;color:#777}
#speed{
 font-size:42vw;font-weight:900;
 line-height:.8;color:var(--green)
}
.limit-display{
 width:90px;height:90px;
 border:8px solid red;border-radius:50%;
 background:#fff;color:#000;
 display:flex;align-items:center;justify-content:center;
 font-weight:900;font-size:2.3rem;margin-top:5px
}

/* BUTTONS */
.btn{
 width:92%;padding:18px;margin-top:10px;
 font-weight:900;border:none;border-radius:40px
}
.green{background:var(--green);color:#000}
.red{background:var(--red);color:#fff}
.gray{background:#333;color:#fff}

/* ALERTS */
#camera-alert{
 position:fixed;top:0;width:100%;
 background:#ffcc00;color:#000;
 font-weight:900;text-align:center;padding:14px;
 display:none;z-index:3000
}
#slow-overlay{
 position:fixed;inset:0;
 background:rgba(255,0,0,.85);
 display:none;z-index:2500;
 align-items:center;justify-content:center;
 font-size:3.5rem;font-weight:900;
 pointer-events:none;text-align:center
}

/* INFO */
.info-btn{
 position:absolute;top:8px;right:8px;
 width:26px;height:26px;
 border-radius:50%;
 border:none;background:#222;
 color:#aaa;font-weight:900
}

/* TABLE */
table{width:100%;border-collapse:collapse;font-size:.75rem}
th{color:var(--green);padding:8px;border-bottom:2px solid #222}
td{padding:12px 4px;border-bottom:1px solid #222;text-align:center}
</style>
</head>

<body>

<!-- README MODAL -->
<div id="modal">
 <div id="modalBox">
  <h3>Speed Guard Pro – Read Me</h3>
  <p>
   • Start Journey enables GPS & keeps screen awake.<br><br>
   • Speed is GPS-based with smoothing (stable = 0).<br><br>
   • Speed limit auto-detected from road data.<br><br>
   • Overspeed triggers sound + SLOW DOWN overlay.<br><br>
   • Speed camera alert shows for 5 seconds.<br><br>
   • Pause freezes tracking without saving.<br><br>
   • History supports delete, import & export.
  </p>
  <button onclick="closeReadme()">GOT IT</button>
 </div>
</div>

<div id="camera-alert">⚠️ SPEED CAMERA AHEAD</div>
<div id="slow-overlay">SLOW<br>DOWN</div>

<div class="nav-tabs">
 <button class="tab-btn active" onclick="openTab('dash')">DASHBOARD</button>
 <button class="tab-btn" onclick="openTab('logs')">HISTORY</button>
</div>

<!-- DASHBOARD -->
<div id="dash" class="tab-content active">
 <button class="info-btn" onclick="openReadme()">ⓘ</button>

 <div class="dash-grid">
  <div class="dash-item"><div class="dash-label">TIME</div><div id="time">00:00:00</div></div>
  <div class="dash-item"><div class="dash-label">KM</div><div id="km">0.00</div></div>
  <div class="dash-item"><div class="dash-label">VIO</div><div id="vio" style="color:var(--red)">0</div></div>
 </div>

 <div class="limit-display" id="limit">--</div>
 <div id="speed">0</div>

 <button class="btn green" onclick="confirmStart()">START JOURNEY</button>
 <button class="btn gray" onclick="togglePause()">PAUSE / RESUME</button>
 <button class="btn red" onclick="confirmStop()">END & SAVE</button>
</div>

<!-- HISTORY -->
<div id="logs" class="tab-content">
 <button class="btn gray" onclick="exportTXT()">EXPORT TXT</button>
 <button class="btn gray" onclick="triggerImport()">IMPORT TXT</button>
 <input type="file" id="fileIn" hidden accept=".txt" onchange="importTXT(event)">
 <button class="btn red" onclick="clearAll()">CLEAR ALL</button>

 <table>
  <thead>
   <tr><th>Date</th><th>KM</th><th>Max</th><th>Vio</th><th>Del</th></tr>
  </thead>
  <tbody id="logBody"></tbody>
 </table>
</div>

<script>
/* README */
function openReadme(){document.getElementById("modal").style.display="flex"}
function closeReadme(){document.getElementById("modal").style.display="none"}
</script>

<script>
/* ===== SOUND (FIXED) ===== */
let audioCtx=null;
function unlockAudio(){
 if(!audioCtx){
  audioCtx=new (window.AudioContext||window.webkitAudioContext)();
 }
 if(audioCtx.state==="suspended") audioCtx.resume();
}
function beep(freq){
 if(!audioCtx) return;
 const o=audioCtx.createOscillator();
 const g=audioCtx.createGain();
 o.frequency.value=freq;
 g.gain.value=0.15;
 o.connect(g);g.connect(audioCtx.destination);
 o.start();o.stop(audioCtx.currentTime+.25);
}

/* ===== CORE LOGIC (UNCHANGED) ===== */
const STORE="SGP_DEPLOY";
let watchID,timerID,wakeLock=null;
let paused=false,wasSpeeding=false;
let lastTime=null,lastFetch=0;
let dist=0,vio=0,maxSpeed=0;
let speedBuf=[],speedLimit=null,cameraCooldown=0;

function openTab(id){
 document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
 document.getElementById(id).classList.add('active');
 if(id==='logs')renderLogs();
}
async function keepAwake(){
 if('wakeLock'in navigator)wakeLock=await navigator.wakeLock.request('screen');
}
async function fetchRoad(lat,lon){
 if(Date.now()-lastFetch<20000)return;
 lastFetch=Date.now();
 const q=`[out:json];way(around:50,${lat},${lon})["maxspeed"];out tags 1;`;
 try{
  const r=await fetch("https://overpass-api.de/api/interpreter?data="+encodeURIComponent(q));
  const j=await r.json();
  if(j.elements.length){
   const v=parseInt(j.elements[0].tags.maxspeed);
   if(!isNaN(v)){
    speedLimit=v;
    document.getElementById("limit").innerText=v;
   }
  }
 }catch{}
}

function confirmStart(){
 if(confirm("Start journey?")){
  unlockAudio();
  startRide();
 }
}
function confirmStop(){
 if(confirm("End journey and save this ride?"))stopRide();
}

function startRide(){
 keepAwake();
 dist=vio=maxSpeed=0;
 speedBuf=[];lastTime=null;
 speedLimit=null;
 document.getElementById("km").innerText="0.00";
 document.getElementById("vio").innerText="0";
 document.getElementById("limit").innerText="--";
 const start=Date.now();

 watchID=navigator.geolocation.watchPosition(p=>{
  if(paused)return;
  let kmh=Math.max(0,(p.coords.speed||0)*3.6);
  speedBuf.push(kmh);if(speedBuf.length>5)speedBuf.shift();
  kmh=speedBuf.reduce((a,b)=>a+b,0)/speedBuf.length;
  if(kmh<2)kmh=0;
  kmh=Math.round(kmh);
  document.getElementById("speed").innerText=kmh;
  maxSpeed=Math.max(maxSpeed,kmh);

  if(lastTime&&kmh>2){
   dist+=(kmh/3600)*((Date.now()-lastTime)/1000);
   document.getElementById("km").innerText=dist.toFixed(2);
  }
  lastTime=Date.now();

  fetchRoad(p.coords.latitude,p.coords.longitude);

  if(speedLimit&&kmh>speedLimit){
   if(!wasSpeeding){vio++;beep(800)}
   wasSpeeding=true;
   document.getElementById("vio").innerText=vio;
   document.getElementById("slow-overlay").style.display="flex";
  }else{
   wasSpeeding=false;
   document.getElementById("slow-overlay").style.display="none";
  }

  if(kmh>40&&Date.now()>cameraCooldown){
   cameraCooldown=Date.now()+60000;
   document.getElementById("camera-alert").style.display="block";
   beep(1600);
   setTimeout(()=>document.getElementById("camera-alert").style.display="none",5000);
  }
 },null,{enableHighAccuracy:true});

 timerID=setInterval(()=>{
  document.getElementById("time").innerText=
   new Date(Date.now()-start).toISOString().substr(11,8);
 },1000);
}

function stopRide(){
 navigator.geolocation.clearWatch(watchID);
 clearInterval(timerID);
 if(wakeLock)wakeLock.release();
 const h=JSON.parse(localStorage.getItem(STORE)||"[]");
 h.push({dt:new Date().toLocaleDateString(),km:dist.toFixed(2),mx:maxSpeed,vio});
 localStorage.setItem(STORE,JSON.stringify(h));
 openTab("logs");
}
function togglePause(){paused=!paused}

/* HISTORY */
function renderLogs(){
 const h=JSON.parse(localStorage.getItem(STORE)||"[]");
 document.getElementById("logBody").innerHTML=
 h.map((r,i)=>`
 <tr>
  <td>${r.dt}</td><td>${r.km}</td><td>${r.mx}</td><td>${r.vio}</td>
  <td onclick="deleteRide(${i})" style="color:#0f0;cursor:pointer">✖</td>
 </tr>`).join("");
}
function deleteRide(i){
 const h=JSON.parse(localStorage.getItem(STORE)||"[]");
 h.splice(i,1);
 localStorage.setItem(STORE,JSON.stringify(h));
 renderLogs();
}
function clearAll(){
 localStorage.removeItem(STORE);
 renderLogs();
}
function exportTXT(){
 const h=JSON.parse(localStorage.getItem(STORE)||"[]");
 const b=new Blob([h.map(r=>JSON.stringify(r)).join("\n")],{type:"text/plain"});
 const a=document.createElement("a");
 a.href=URL.createObjectURL(b);
 a.download="speedguard_rides.txt";
 a.click();
}
function triggerImport(){document.getElementById("fileIn").click()}
function importTXT(e){
 const r=new FileReader();
 r.onload=()=>{
  const h=JSON.parse(localStorage.getItem(STORE)||"[]");
  r.result.split("\n").forEach(l=>{try{h.push(JSON.parse(l))}catch{}});
  localStorage.setItem(STORE,JSON.stringify(h));
  renderLogs();
 };
 r.readAsText(e.target.files[0]);
}
</script>

</body>
</html>
