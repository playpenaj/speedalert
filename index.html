<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0f0f0f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <title>MotoDash Pro - GPS Speedometer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* === PROFESSIONAL DARK THEME === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
            font-family: 'Inter', 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif;
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

        :root {
            --bg-primary: #0f0f0f;
            --bg-secondary: #1a1a1a;
            --bg-card: #1e1e1e;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --accent-blue: #3b82f6;
            --accent-red: #ef4444;
            --accent-yellow: #eab308;
            --accent-green: #22c55e;
            --border-subtle: #2a2a2a;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-height: 100vh;
            width: 100%;
        }

        /* ========== SPEEDOMETER SECTION ========== */
        .speedometer-section {
            height: 55vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: radial-gradient(circle at 50% 30%, #1e1e1e, #0a0a0a);
            position: relative;
            padding: 20px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .status-bar {
            position: absolute;
            top: 15px;
            left: 15px;
            right: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        .region-badge {
            background: var(--bg-card);
            color: var(--text-primary);
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid var(--border-subtle);
            box-shadow: var(--shadow);
        }

        .gps-status {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-card);
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-blue);
            border: 1px solid var(--border-subtle);
            box-shadow: var(--shadow);
        }

        .gps-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent-green);
            animation: pulse 2s infinite;
        }

        .speed-limit-panel {
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--bg-card);
            border-radius: 20px;
            padding: 12px 20px;
            box-shadow: var(--shadow);
            border: 2px solid var(--accent-red);
            text-align: center;
            min-width: 120px;
        }

        .speed-limit-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            margin-bottom: 4px;
        }

        .speed-limit-header i {
            color: var(--accent-red);
            font-size: 14px;
        }

        .speed-limit-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .speed-limit-value {
            font-size: 40px;
            font-weight: 800;
            color: var(--accent-red);
            line-height: 1;
        }

        .speed-limit-unit {
            font-size: 14px;
            color: var(--text-secondary);
            margin-left: 4px;
        }

        .capture-status {
            position: absolute;
            bottom: 20px;
            left: 15px;
            right: 15px;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .capture-badge {
            background: var(--bg-card);
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid var(--border-subtle);
            box-shadow: var(--shadow);
        }

        .capture-badge.active {
            border-color: var(--accent-green);
            color: var(--accent-green);
        }

        .speed-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
        }

        .current-speed {
            font-size: 160px;
            font-weight: 800;
            color: var(--accent-blue);
            line-height: 0.9;
            transition: color 0.2s;
        }

        .speed-unit {
            font-size: 28px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-top: 8px;
        }

        .speed-over-limit {
            color: var(--accent-red) !important;
        }

        /* ========== TRIP INFO SECTION ========== */
        .trip-section {
            height: 30vh;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            background: var(--bg-secondary);
            padding: 16px;
            gap: 12px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .trip-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 12px 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border: 1px solid var(--border-subtle);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .trip-icon {
            color: var(--accent-blue);
            font-size: 20px;
            margin-bottom: 6px;
        }

        .trip-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .trip-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .trip-value.overspeed {
            color: var(--accent-red);
        }

        /* ========== CONTROL BAR (FIXED BOTTOM) ========== */
        .control-bar {
            height: 15vh;
            background: var(--bg-secondary);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            padding: 0 20px;
            border-top: 1px solid var(--border-subtle);
            box-shadow: 0 -4px 10px rgba(0,0,0,0.5);
            z-index: 20;
        }

        .btn {
            flex: 1;
            max-width: 160px;
            border: none;
            border-radius: 40px;
            padding: 16px 0;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            transition: all 0.2s;
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .btn:active {
            transform: translateY(2px);
            opacity: 0.9;
        }

        .btn i {
            font-size: 24px;
        }

        .btn-start {
            background: linear-gradient(145deg, #22c55e, #16a34a);
        }

        .btn-stop {
            background: linear-gradient(145deg, #ef4444, #dc2626);
        }

        .btn-stop:disabled {
            opacity: 0.3;
            transform: none;
            cursor: not-allowed;
            filter: grayscale(0.8);
        }

        .btn-history {
            background: linear-gradient(145deg, #3b82f6, #2563eb);
        }

        .btn-settings {
            position: absolute;
            bottom: calc(15vh + 20px);
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 28px;
            background: var(--bg-card);
            color: var(--accent-blue);
            border: 1px solid var(--border-subtle);
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow);
            z-index: 30;
        }

        /* ========== MODALS ========== */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            display: none;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: 24px;
            width: 100%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
            border: 1px solid var(--border-subtle);
            box-shadow: var(--shadow);
        }

        .modal-header {
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 20px 25px;
            border-radius: 24px 24px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-subtle);
        }

        .modal-title {
            font-size: 22px;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 28px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-body {
            padding: 25px;
            color: var(--text-primary);
        }

        .alert-modal {
            background: rgba(0,0,0,0.95);
        }

        .alert-content {
            background: var(--bg-card);
            border-radius: 24px;
            padding: 30px;
            text-align: center;
            max-width: 400px;
            animation: pulse 0.5s ease;
            border: 2px solid;
        }

        .camera-alert .alert-content {
            border-color: var(--accent-yellow);
        }

        .speed-alert .alert-content {
            border-color: var(--accent-red);
        }

        .alert-icon {
            font-size: 70px;
            margin-bottom: 20px;
        }

        .camera-alert .alert-icon {
            color: var(--accent-yellow);
        }

        .speed-alert .alert-icon {
            color: var(--accent-red);
        }

        .alert-title {
            font-size: 26px;
            font-weight: 800;
            margin-bottom: 10px;
        }

        .camera-alert .alert-title {
            color: var(--accent-yellow);
        }

        .speed-alert .alert-title {
            color: var(--accent-red);
        }

        .alert-distance {
            font-size: 22px;
            font-weight: 700;
            color: var(--accent-blue);
            margin: 15px 0;
            padding: 10px;
            background: rgba(59,130,246,0.1);
            border-radius: 12px;
        }

        .alert-message {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .alert-btn {
            background: var(--accent-blue);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px 30px;
            font-size: 18px;
            font-weight: 600;
            width: 100%;
            cursor: pointer;
        }

        .sound-option {
            display: flex;
            align-items: center;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
            color: var(--text-primary);
        }

        .sound-option.selected {
            border-color: var(--accent-blue);
            background: rgba(59,130,246,0.1);
        }

        .sound-option i {
            font-size: 26px;
            color: var(--accent-blue);
            margin-right: 15px;
            width: 40px;
            text-align: center;
        }

        .sound-info {
            flex: 1;
        }

        .sound-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .sound-desc {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .test-btn {
            background: var(--accent-blue);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            color: var(--text-primary);
        }

        .history-table th {
            background: var(--bg-secondary);
            padding: 15px;
            text-align: left;
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-blue);
            border-bottom: 2px solid var(--border-subtle);
        }

        .history-table td {
            padding: 15px;
            border-bottom: 1px solid var(--border-subtle);
            font-size: 14px;
        }

        .history-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .history-btn {
            flex: 1;
            min-width: 100px;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-subtle);
        }

        .history-btn.download {
            background: var(--accent-green);
            color: black;
        }

        .history-btn.upload {
            background: var(--accent-blue);
            color: white;
        }

        .history-btn.clear {
            background: var(--accent-red);
            color: white;
        }

        .region-selector {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }

        .region-option {
            flex: 1;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
            color: var(--text-primary);
        }

        .region-option.selected {
            border-color: var(--accent-blue);
            background: rgba(59,130,246,0.1);
        }

        .region-option i {
            font-size: 32px;
            color: var(--accent-blue);
            margin-bottom: 8px;
        }

        .region-name {
            font-weight: 600;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0% { transform: scale(0.95); opacity: 0.8; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }

        @media (max-width: 768px) {
            .current-speed { font-size: 120px; }
            .trip-section { grid-template-columns: repeat(2, 1fr); height: auto; min-height: 25vh; }
            .control-bar { height: 12vh; }
            .btn-settings { bottom: calc(12vh + 20px); }
        }

        @media (max-width: 480px) {
            .current-speed { font-size: 100px; }
            .btn { padding: 12px 0; font-size: 14px; }
            .btn i { font-size: 20px; }
        }

        @media (orientation: landscape) {
            .speedometer-section { height: 50vh; }
            .trip-section { height: 30vh; }
            .control-bar { height: 20vh; }
            .btn-settings { bottom: calc(20vh + 20px); }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Speedometer Section -->
        <div class="speedometer-section">
            <div class="status-bar">
                <div class="region-badge" id="regionDisplay">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>Singapore</span>
                </div>
                <div class="gps-status">
                    <div class="gps-dot" id="gpsDot"></div>
                    <span id="gpsStatusText">GPS ACTIVE</span>
                </div>
            </div>

            <div class="speed-limit-panel" id="speedLimitPanel">
                <div class="speed-limit-header">
                    <i class="fas fa-shield-alt"></i>
                    <span class="speed-limit-label">SPEED LIMIT</span>
                </div>
                <div>
                    <span class="speed-limit-value" id="speedLimitValue">50</span>
                    <span class="speed-limit-unit">km/h</span>
                </div>
            </div>

            <div class="speed-display">
                <div class="current-speed" id="currentSpeed">0</div>
                <div class="speed-unit">km/h</div>
            </div>

            <div class="capture-status" id="captureStatus">
                <div class="capture-badge active" id="gpsLockBadge">
                    <i class="fas fa-satellite"></i>
                    <span>GPS Locked</span>
                </div>
                <div class="capture-badge" id="speedLimitCapturedBadge">
                    <i class="fas fa-traffic-light"></i>
                    <span>Speed Limit: Waiting...</span>
                </div>
            </div>
        </div>

        <!-- Trip Info Section -->
        <div class="trip-section">
            <div class="trip-card">
                <i class="fas fa-route trip-icon"></i>
                <div class="trip-label">DISTANCE</div>
                <div class="trip-value" id="distanceValue">0.00 km</div>
            </div>
            <div class="trip-card">
                <i class="fas fa-clock trip-icon"></i>
                <div class="trip-label">TIME</div>
                <div class="trip-value" id="timeValue">00:00:00</div>
            </div>
            <div class="trip-card">
                <i class="fas fa-exclamation-triangle trip-icon" style="color: var(--accent-red);"></i>
                <div class="trip-label">OVERSPEED</div>
                <div class="trip-value overspeed" id="overspeedValue">0:00</div>
            </div>
            <div class="trip-card">
                <i class="fas fa-tachometer-alt trip-icon"></i>
                <div class="trip-label">AVG SPEED</div>
                <div class="trip-value" id="avgSpeedValue">0 km/h</div>
            </div>
        </div>

        <!-- Control Bar -->
        <div class="control-bar">
            <button class="btn btn-start" id="startBtn">
                <i class="fas fa-play"></i>
                <span>START</span>
            </button>
            <button class="btn btn-stop" id="stopBtn" disabled>
                <i class="fas fa-stop"></i>
                <span>STOP</span>
            </button>
            <button class="btn btn-history" id="historyBtn">
                <i class="fas fa-history"></i>
                <span>HISTORY</span>
            </button>
        </div>

        <!-- Settings Button -->
        <button class="btn-settings" id="settingsBtn">
            <i class="fas fa-cog"></i>
        </button>

        <!-- Start Modal -->
        <div class="modal" id="startModal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">START TRIP</div>
                    <button class="modal-close" id="closeStartModal">&times;</button>
                </div>
                <div class="modal-body">
                    <div style="text-align: center; margin-bottom: 25px;">
                        <i class="fas fa-motorcycle" style="font-size: 60px; color: var(--accent-blue);"></i>
                    </div>
                    <p style="font-size: 18px; margin-bottom: 25px; text-align: center;">
                        Ready to start recording your trip?
                    </p>
                    <p style="color: var(--text-secondary); margin-bottom: 30px; text-align: center;">
                        Speedometer shows your real GPS speed. Trip recording will track distance, time, and speed violations.
                    </p>
                    <div style="display: flex; gap: 15px;">
                        <button class="btn btn-start" id="confirmStart" style="flex: 1;">START TRIP</button>
                        <button class="btn" style="flex: 1; background: #333; color: white;" id="cancelStart">CANCEL</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stop Modal -->
        <div class="modal" id="stopModal">
            <div class="modal-content">
                <div class="modal-header" style="background: var(--accent-red); color: white;">
                    <div class="modal-title">END TRIP</div>
                    <button class="modal-close" id="closeStopModal">&times;</button>
                </div>
                <div class="modal-body">
                    <div style="text-align: center; margin-bottom: 25px;">
                        <i class="fas fa-flag-checkered" style="font-size: 60px; color: var(--accent-red);"></i>
                    </div>
                    <p style="font-size: 18px; margin-bottom: 25px; text-align: center;">
                        End current trip and save to history?
                    </p>
                    <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; margin-bottom: 30px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>Distance:</span>
                            <span style="font-weight: 700;" id="stopDistance">0.00 km</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>Duration:</span>
                            <span style="font-weight: 700;" id="stopDuration">00:00:00</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>Overspeed:</span>
                            <span style="font-weight: 700; color: var(--accent-red);" id="stopOverspeed">0:00</span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 15px;">
                        <button class="btn" style="flex: 1; background: var(--accent-red); color: white;" id="confirmStop">END TRIP</button>
                        <button class="btn" style="flex: 1; background: #333; color: white;" id="cancelStop">CONTINUE</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div class="modal" id="settingsModal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">SETTINGS</div>
                    <button class="modal-close" id="closeSettingsModal">&times;</button>
                </div>
                <div class="modal-body">
                    <!-- Region Selection -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="margin-bottom: 15px; color: var(--accent-blue);">üìç Region</h3>
                        <div class="region-selector">
                            <div class="region-option selected" data-region="sg" id="regionSG">
                                <i class="fas fa-map"></i>
                                <div class="region-name">Singapore</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">50-90 km/h</div>
                            </div>
                            <div class="region-option" data-region="in" id="regionIN">
                                <i class="fas fa-map"></i>
                                <div class="region-name">India</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">40-80 km/h</div>
                            </div>
                        </div>
                    </div>

                    <!-- Camera Alert Sound -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="margin-bottom: 15px; color: var(--accent-yellow);">üì∏ Camera Alert Sound</h3>
                        <div class="sound-option" data-sound="camera1">
                            <i class="fas fa-bell"></i>
                            <div class="sound-info">
                                <div class="sound-name">Standard Beep</div>
                                <div class="sound-desc">Clear single beep</div>
                            </div>
                            <button class="test-btn">TEST</button>
                        </div>
                        <div class="sound-option selected" data-sound="camera2">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div class="sound-info">
                                <div class="sound-name">Warning Tone</div>
                                <div class="sound-desc">Urgent double beep</div>
                            </div>
                            <button class="test-btn">TEST</button>
                        </div>
                        <div class="sound-option" data-sound="camera3">
                            <i class="fas fa-volume-up"></i>
                            <div class="sound-info">
                                <div class="sound-name">Siren</div>
                                <div class="sound-desc">Police-style siren</div>
                            </div>
                            <button class="test-btn">TEST</button>
                        </div>
                    </div>

                    <!-- Speed Alert Sound -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="margin-bottom: 15px; color: var(--accent-red);">‚ö†Ô∏è Speed Alert Sound</h3>
                        <div class="sound-option" data-sound="speed1">
                            <i class="fas fa-bell"></i>
                            <div class="sound-info">
                                <div class="sound-name">Standard Alert</div>
                                <div class="sound-desc">Repeating beep</div>
                            </div>
                            <button class="test-btn">TEST</button>
                        </div>
                        <div class="sound-option selected" data-sound="speed2">
                            <i class="fas fa-exclamation"></i>
                            <div class="sound-info">
                                <div class="sound-name">Urgent Warning</div>
                                <div class="sound-desc">Fast repeating beep</div>
                            </div>
                            <button class="test-btn">TEST</button>
                        </div>
                        <div class="sound-option" data-sound="speed3">
                            <i class="fas fa-volume-up"></i>
                            <div class="sound-info">
                                <div class="sound-name">Siren Pulse</div>
                                <div class="sound-desc">Pulsing alarm</div>
                            </div>
                            <button class="test-btn">TEST</button>
                        </div>
                    </div>

                    <!-- Alert Settings -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="margin-bottom: 15px; color: var(--accent-blue);">üéØ Alert Settings</h3>
                        <div style="margin-bottom: 20px;">
                            <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                                <input type="checkbox" id="cameraAlertsToggle" checked style="accent-color: var(--accent-blue);">
                                <span style="font-weight: 500;">Enable Camera Alerts</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="speedAlertsToggle" checked style="accent-color: var(--accent-blue);">
                                <span style="font-weight: 500;">Enable Speed Alerts</span>
                            </label>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 10px; font-weight: 500;">Alert Distance</label>
                            <input type="range" id="cameraDistance" min="100" max="1000" step="50" value="500" style="width: 100%; accent-color: var(--accent-blue);">
                            <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                                <span>100m</span>
                                <span id="cameraDistanceValue" style="font-weight: 600; color: var(--accent-blue);">500m</span>
                                <span>1000m</span>
                            </div>
                        </div>
                    </div>

                    <!-- App Info -->
                    <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px;">
                        <h3 style="margin-bottom: 10px; color: var(--accent-blue);">‚ÑπÔ∏è App Info</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 5px;">MotoDash Pro v7.0</p>
                        <p style="color: var(--text-secondary); margin-bottom: 5px;">Works in Singapore & India</p>
                        <p style="color: var(--text-secondary);">Real GPS ‚Äì Speed limit simulated (demo)</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Modal -->
        <div class="modal" id="historyModal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">TRIP HISTORY</div>
                    <button class="modal-close" id="closeHistoryModal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="history-actions">
                        <button class="history-btn download" id="downloadHistoryBtn">
                            <i class="fas fa-download"></i> DOWNLOAD
                        </button>
                        <button class="history-btn upload" id="uploadHistoryBtn">
                            <i class="fas fa-upload"></i> UPLOAD
                        </button>
                        <button class="history-btn clear" id="clearHistoryBtn">
                            <i class="fas fa-trash"></i> CLEAR
                        </button>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="history-table">
                            <thead>
                                <tr>
                                    <th>DATE</th>
                                    <th>DISTANCE</th>
                                    <th>TIME</th>
                                    <th>OVERSPEED</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody"></tbody>
                        </table>
                    </div>
                    <div id="emptyHistory" style="display: none; text-align: center; padding: 40px;">
                        <i class="fas fa-history" style="font-size: 48px; color: #333; margin-bottom: 15px;"></i>
                        <h3 style="color: #666;">No Trip History</h3>
                        <p style="color: #999;">Start a trip to record your journey</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Camera Alert Modal -->
        <div class="modal alert-modal camera-alert" id="cameraAlertModal">
            <div class="alert-content">
                <div class="alert-icon">
                    <i class="fas fa-camera"></i>
                </div>
                <div class="alert-title">SPEED CAMERA</div>
                <div class="alert-distance" id="cameraDistanceDisplay">500m</div>
                <div class="alert-message">
                    Camera detected ahead. Reduce speed.
                </div>
                <button class="alert-btn" id="closeCameraAlert">ACKNOWLEDGE</button>
            </div>
        </div>

        <!-- Speed Alert Modal -->
        <div class="modal alert-modal speed-alert" id="speedAlertModal">
            <div class="alert-content">
                <div class="alert-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="alert-title">OVER SPEED LIMIT</div>
                <div class="alert-message">
                    You are exceeding the speed limit.<br>
                    <span style="font-size: 20px; font-weight: 700; color: var(--accent-red);" id="speedAlertCurrent">50</span>
                    <span style="color: #666;"> / </span>
                    <span style="font-size: 20px; font-weight: 700; color: var(--accent-blue);" id="speedAlertLimit">50</span>
                    <span style="color: #666;"> km/h</span>
                </div>
                <button class="alert-btn" style="background: var(--accent-red);" id="closeSpeedAlert">SLOW DOWN</button>
            </div>
        </div>

        <!-- Hidden audio elements -->
        <audio id="cameraSound1" preload="auto"></audio>
        <audio id="cameraSound2" preload="auto"></audio>
        <audio id="cameraSound3" preload="auto"></audio>
        <audio id="speedSound1" preload="auto"></audio>
        <audio id="speedSound2" preload="auto"></audio>
        <audio id="speedSound3" preload="auto"></audio>

        <!-- Hidden file input -->
        <input type="file" id="historyFileInput" accept=".json" style="display: none;">
    </div>

    <script>
        (function() {
            // ==================== STATE ====================
            const appState = {
                isTripActive: false,
                tripStartTime: null,
                tripTimer: null,
                distance: 0,
                overspeedSeconds: 0,
                speedLimit: 50,
                currentSpeed: 0,
                wakeLock: null,
                tripHistory: [],
                cameraAlertActive: false,
                speedAlertActive: false,
                cameraLocations: [],
                currentCameraSound: 'camera2',
                currentSpeedSound: 'speed2',
                cameraAlertDistance: 500,
                cameraAlertsEnabled: true,
                speedAlertsEnabled: true,
                region: 'sg',
                speedLimitCaptured: false,
                lastPosition: null,
                lastTimestamp: null,
                watchId: null,
                gpsError: false,
                distanceSinceLastLimitCheck: 0
            };

            const speedLimitDB = {
                sg: { default: 50, limits: [30,40,50,60,70,80,90] },
                in: { default: 50, limits: [30,40,50,60,70,80] }
            };

            // ==================== DOM ELEMENTS ====================
            const currentSpeedEl = document.getElementById('currentSpeed');
            const speedLimitValueEl = document.getElementById('speedLimitValue');
            const distanceEl = document.getElementById('distanceValue');
            const timeEl = document.getElementById('timeValue');
            const overspeedEl = document.getElementById('overspeedValue');
            const avgSpeedEl = document.getElementById('avgSpeedValue');
            const regionDisplay = document.getElementById('regionDisplay');
            const speedLimitCapturedBadge = document.getElementById('speedLimitCapturedBadge');
            const gpsStatusText = document.getElementById('gpsStatusText');
            const gpsDot = document.getElementById('gpsDot');

            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            const historyBtn = document.getElementById('historyBtn');
            const settingsBtn = document.getElementById('settingsBtn');

            const startModal = document.getElementById('startModal');
            const stopModal = document.getElementById('stopModal');
            const settingsModal = document.getElementById('settingsModal');
            const historyModal = document.getElementById('historyModal');
            const cameraAlertModal = document.getElementById('cameraAlertModal');
            const speedAlertModal = document.getElementById('speedAlertModal');

            const closeStartModal = document.getElementById('closeStartModal');
            const closeStopModal = document.getElementById('closeStopModal');
            const closeSettingsModal = document.getElementById('closeSettingsModal');
            const closeHistoryModal = document.getElementById('closeHistoryModal');
            const closeCameraAlert = document.getElementById('closeCameraAlert');
            const closeSpeedAlert = document.getElementById('closeSpeedAlert');

            const confirmStart = document.getElementById('confirmStart');
            const cancelStart = document.getElementById('cancelStart');
            const confirmStop = document.getElementById('confirmStop');
            const cancelStop = document.getElementById('cancelStop');

            const historyTableBody = document.getElementById('historyTableBody');
            const emptyHistory = document.getElementById('emptyHistory');
            const downloadHistoryBtn = document.getElementById('downloadHistoryBtn');
            const uploadHistoryBtn = document.getElementById('uploadHistoryBtn');
            const clearHistoryBtn = document.getElementById('clearHistoryBtn');
            const historyFileInput = document.getElementById('historyFileInput');

            const cameraDistanceSlider = document.getElementById('cameraDistance');
            const cameraDistanceValue = document.getElementById('cameraDistanceValue');
            const cameraAlertsToggle = document.getElementById('cameraAlertsToggle');
            const speedAlertsToggle = document.getElementById('speedAlertsToggle');
            const cameraDistanceDisplay = document.getElementById('cameraDistanceDisplay');
            const speedAlertCurrent = document.getElementById('speedAlertCurrent');
            const speedAlertLimit = document.getElementById('speedAlertLimit');
            const regionSG = document.getElementById('regionSG');
            const regionIN = document.getElementById('regionIN');

            const stopDistance = document.getElementById('stopDistance');
            const stopDuration = document.getElementById('stopDuration');
            const stopOverspeed = document.getElementById('stopOverspeed');

            const cameraSounds = {
                camera1: document.getElementById('cameraSound1'),
                camera2: document.getElementById('cameraSound2'),
                camera3: document.getElementById('cameraSound3')
            };
            const speedSounds = {
                speed1: document.getElementById('speedSound1'),
                speed2: document.getElementById('speedSound2'),
                speed3: document.getElementById('speedSound3')
            };

            // ==================== AUDIO SETUP ====================
            let audioContext;
            function initAudio() {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    document.addEventListener('touchstart', resumeAudio);
                    document.addEventListener('click', resumeAudio);
                    preloadSounds();
                } catch (e) { console.log('Web Audio not supported'); }
            }
            function resumeAudio() {
                if (audioContext && audioContext.state === 'suspended') audioContext.resume();
            }
            function preloadSounds() {
                const urls = {
                    camera1: 'https://actions.google.com/sounds/v1/alarms/digital_watch_alarm.ogg',
                    camera2: 'https://actions.google.com/sounds/v1/alarms/beep_short.ogg',
                    camera3: 'https://actions.google.com/sounds/v1/alarms/spaceship_alarm.ogg',
                    speed1: 'https://actions.google.com/sounds/v1/alarms/bugle_tune.ogg',
                    speed2: 'https://actions.google.com/sounds/v1/alarms/medium_bell_ringing_near.ogg',
                    speed3: 'https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg'
                };
                for (let [key, url] of Object.entries(urls)) {
                    const audio = cameraSounds[key] || speedSounds[key];
                    if (audio) { audio.src = url; audio.load(); }
                }
            }

            // ==================== GPS ====================
            function startGPS() {
                if (!navigator.geolocation) {
                    gpsStatusText.innerText = 'GPS NOT SUPPORTED';
                    gpsDot.style.background = 'gray';
                    return;
                }
                appState.watchId = navigator.geolocation.watchPosition(
                    pos => {
                        gpsStatusText.innerText = 'GPS ACTIVE';
                        gpsDot.style.background = 'var(--accent-green)';
                        appState.gpsError = false;
                        const coords = pos.coords;
                        let speed = coords.speed ? coords.speed * 3.6 : 0;
                        if (speed === 0 && appState.lastPosition) {
                            const d = calculateDistance(appState.lastPosition.lat, appState.lastPosition.lon, coords.latitude, coords.longitude);
                            const dt = (pos.timestamp - appState.lastTimestamp) / 1000;
                            if (dt > 0) speed = (d / dt) * 3600;
                        }
                        appState.currentSpeed = Math.max(0, Math.round(speed * 10) / 10);
                        currentSpeedEl.textContent = Math.round(appState.currentSpeed);
                        if (appState.currentSpeed > appState.speedLimit) {
                            currentSpeedEl.classList.add('speed-over-limit');
                        } else {
                            currentSpeedEl.classList.remove('speed-over-limit');
                        }
                        if (appState.isTripActive && appState.lastPosition) {
                            const delta = calculateDistance(appState.lastPosition.lat, appState.lastPosition.lon, coords.latitude, coords.longitude);
                            appState.distance += delta;
                            appState.distanceSinceLastLimitCheck += delta;
                            distanceEl.textContent = appState.distance.toFixed(2) + ' km';
                        }
                        appState.lastPosition = { lat: coords.latitude, lon: coords.longitude };
                        appState.lastTimestamp = pos.timestamp;

                        // Speed limit capture after moving 0.2 km (200m)
                        if (appState.isTripActive && !appState.speedLimitCaptured && appState.distanceSinceLastLimitCheck >= 0.2) {
                            captureSpeedLimit();
                        }
                    },
                    err => {
                        gpsStatusText.innerText = 'GPS ERROR';
                        gpsDot.style.background = 'var(--accent-red)';
                        appState.gpsError = true;
                        appState.currentSpeed = 0;
                        currentSpeedEl.textContent = '0';
                        currentSpeedEl.classList.remove('speed-over-limit');
                    },
                    { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
                );
            }

            function calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371;
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
                return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            }

            // ==================== SPEED LIMIT CAPTURE ====================
            function captureSpeedLimit() {
                // Simulate realistic limit based on current speed and region
                let newLimit = 50;
                if (appState.currentSpeed < 35) newLimit = 40;
                else if (appState.currentSpeed < 55) newLimit = 50;
                else if (appState.currentSpeed < 75) newLimit = 70;
                else newLimit = 90;
                const limits = speedLimitDB[appState.region].limits;
                newLimit = limits.reduce((prev, curr) => Math.abs(curr - newLimit) < Math.abs(prev - newLimit) ? curr : prev);
                appState.speedLimit = newLimit;
                speedLimitValueEl.textContent = appState.speedLimit;
                appState.speedLimitCaptured = true;
                speedLimitCapturedBadge.innerHTML = `<i class="fas fa-traffic-light"></i><span>Speed Limit: ${appState.speedLimit} km/h</span>`;
                speedLimitCapturedBadge.classList.add('active');
                showNotification(`Speed limit: ${appState.speedLimit} km/h`);
                appState.distanceSinceLastLimitCheck = 0; // reset for possible future changes (optional)
            }

            // ==================== MONITORING ====================
            function startMonitoring() {
                setInterval(() => {
                    if (!appState.isTripActive) return;
                    if (appState.currentSpeed > appState.speedLimit) {
                        appState.overspeedSeconds++;
                        const m = Math.floor(appState.overspeedSeconds / 60);
                        const s = appState.overspeedSeconds % 60;
                        overspeedEl.textContent = `${m}:${s.toString().padStart(2,'0')}`;
                        if (appState.speedAlertsEnabled && !appState.speedAlertActive) showSpeedAlert();
                    }
                    if (appState.cameraAlertsEnabled) checkForCameras();
                }, 1000);
            }

            // ==================== CAMERAS ====================
            function generateCameraLocations() {
                appState.cameraLocations = [];
                for (let i = 0; i < 15; i++) {
                    appState.cameraLocations.push({ id: i, distance: Math.floor(Math.random()*10000)+1000, triggered: false });
                }
            }
            function checkForCameras() {
                if (!appState.isTripActive || !appState.cameraAlertsEnabled) return;
                const curM = appState.distance * 1000;
                appState.cameraLocations.forEach(cam => {
                    if (!cam.triggered && Math.abs(cam.distance - curM) <= appState.cameraAlertDistance) {
                        triggerCameraAlert(cam, Math.round(Math.abs(cam.distance - curM)));
                    }
                });
            }
            function triggerCameraAlert(cam, dist) {
                if (appState.cameraAlertActive) return;
                appState.cameraAlertActive = true;
                cam.triggered = true;
                cameraDistanceDisplay.textContent = dist + 'm';
                playSound(appState.currentCameraSound);
                showModal(cameraAlertModal);
                setTimeout(() => { if (appState.cameraAlertActive) { hideModal(cameraAlertModal); appState.cameraAlertActive = false; } }, 7000);
            }
            function resetCameraTriggers() { appState.cameraLocations.forEach(c => c.triggered = false); }

            // ==================== TRIP CONTROL ====================
            function startTrip() {
                appState.isTripActive = true;
                appState.tripStartTime = new Date();
                appState.distance = 0;
                appState.overspeedSeconds = 0;
                appState.speedLimitCaptured = false;
                appState.lastPosition = null;
                appState.distanceSinceLastLimitCheck = 0;
                distanceEl.textContent = '0.00 km';
                timeEl.textContent = '00:00:00';
                overspeedEl.textContent = '0:00';
                avgSpeedEl.textContent = '0 km/h';
                speedLimitCapturedBadge.innerHTML = '<i class="fas fa-traffic-light"></i><span>Speed Limit: Capturing...</span>';
                speedLimitCapturedBadge.classList.remove('active');
                hideModal(startModal);
                startBtn.disabled = true;
                stopBtn.disabled = false;
                startTripTimer();
                resetCameraTriggers();
                requestWakeLock(); // ensure wake lock is active during trip
                showNotification('Trip started ‚Äì ride safe!');
            }

            function stopTrip() {
                appState.isTripActive = false;
                clearInterval(appState.tripTimer);
                saveTripToHistory();
                hideModal(stopModal);
                startBtn.disabled = false;
                stopBtn.disabled = true;
                distanceEl.textContent = '0.00 km';
                timeEl.textContent = '00:00:00';
                overspeedEl.textContent = '0:00';
                avgSpeedEl.textContent = '0 km/h';
                speedLimitCapturedBadge.innerHTML = '<i class="fas fa-traffic-light"></i><span>Speed Limit: Waiting...</span>';
                speedLimitCapturedBadge.classList.remove('active');
                // Release wake lock? We'll keep it always on, but can release if needed.
                // Not necessary to release.
                showNotification('Trip saved to history');
            }

            function showStopConfirmation() {
                stopDistance.textContent = distanceEl.textContent;
                stopDuration.textContent = timeEl.textContent;
                stopOverspeed.textContent = overspeedEl.textContent;
                showModal(stopModal);
            }

            function startTripTimer() {
                appState.tripTimer = setInterval(() => {
                    if (!appState.isTripActive) return;
                    const now = new Date();
                    const diff = Math.floor((now - appState.tripStartTime) / 1000);
                    const h = Math.floor(diff / 3600);
                    const m = Math.floor((diff % 3600) / 60);
                    const s = diff % 60;
                    timeEl.textContent = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                    if (diff > 0) {
                        const avg = appState.distance / (diff / 3600);
                        avgSpeedEl.textContent = Math.round(avg) + ' km/h';
                    }
                }, 1000);
            }

            // ==================== SOUND ====================
            function playSound(soundId) {
                try {
                    if (audioContext && audioContext.state === 'running') {
                        playWebAudioSound(soundId);
                    } else {
                        const audio = soundId.startsWith('camera') ? cameraSounds[soundId] : speedSounds[soundId];
                        if (audio) {
                            audio.currentTime = 0;
                            audio.volume = 1.0; // 100% volume
                            audio.play().catch(e => playWebAudioSound(soundId));
                        }
                    }
                } catch (e) { console.log('Sound error'); }
            }

            function playWebAudioSound(soundId) {
                if (!audioContext) return;
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.connect(gain); gain.connect(audioContext.destination);
                gain.gain.value = 1.0; // 100% volume
                switch(soundId) {
                    case 'camera1':
                        osc.frequency.value = 800;
                        gain.gain.setValueAtTime(1.0, audioContext.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                        osc.start(); osc.stop(audioContext.currentTime + 0.2); break;
                    case 'camera2':
                        osc.frequency.value = 1000;
                        gain.gain.setValueAtTime(1.0, audioContext.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                        osc.start(); osc.stop(audioContext.currentTime + 0.1);
                        setTimeout(() => {
                            const osc2 = audioContext.createOscillator();
                            const gain2 = audioContext.createGain();
                            osc2.connect(gain2); gain2.connect(audioContext.destination);
                            osc2.frequency.value = 1000;
                            gain2.gain.setValueAtTime(1.0, audioContext.currentTime);
                            gain2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                            osc2.start(); osc2.stop(audioContext.currentTime + 0.1);
                        }, 150);
                        break;
                    case 'camera3':
                        osc.type = 'sawtooth';
                        osc.frequency.value = 600;
                        gain.gain.setValueAtTime(0.8, audioContext.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                        osc.start(); osc.stop(audioContext.currentTime + 0.5); break;
                    case 'speed1':
                        for (let i=0;i<3;i++) setTimeout(() => { let o=audioContext.createOscillator(),g=audioContext.createGain(); o.connect(g); g.connect(audioContext.destination); o.frequency.value=600; g.gain.setValueAtTime(1.0,audioContext.currentTime); g.gain.exponentialRampToValueAtTime(0.01,audioContext.currentTime+0.1); o.start(); o.stop(audioContext.currentTime+0.1); }, i*200);
                        break;
                    case 'speed2':
                        for (let i=0;i<5;i++) setTimeout(() => { let o=audioContext.createOscillator(),g=audioContext.createGain(); o.connect(g); g.connect(audioContext.destination); o.frequency.value=800; g.gain.setValueAtTime(1.0,audioContext.currentTime); g.gain.exponentialRampToValueAtTime(0.01,audioContext.currentTime+0.08); o.start(); o.stop(audioContext.currentTime+0.08); }, i*120);
                        break;
                    case 'speed3':
                        const start = audioContext.currentTime;
                        osc.type='sawtooth';
                        for (let i=0;i<6;i++) { let t = start + i*0.15; osc.frequency.setValueAtTime(600,t); osc.frequency.linearRampToValueAtTime(800,t+0.07); osc.frequency.linearRampToValueAtTime(600,t+0.14); }
                        gain.gain.setValueAtTime(0.8,start);
                        gain.gain.exponentialRampToValueAtTime(0.01,start+1);
                        osc.start(); osc.stop(start+1); break;
                }
            }

            // ==================== SOUND SELECTION ====================
            function selectSound(option) {
                const container = option.closest('.settings-section');
                container.querySelectorAll('.sound-option').forEach(o => o.classList.remove('selected'));
                option.classList.add('selected');
                const type = option.dataset.sound;
                if (type.startsWith('camera')) appState.currentCameraSound = type;
                else appState.currentSpeedSound = type;
                saveSettings();
            }

            function applySettingsToUI() {
                document.querySelectorAll('.settings-section:nth-of-type(2) .sound-option').forEach(opt => {
                    opt.classList.remove('selected');
                    if (opt.dataset.sound === appState.currentCameraSound) opt.classList.add('selected');
                });
                document.querySelectorAll('.settings-section:nth-of-type(3) .sound-option').forEach(opt => {
                    opt.classList.remove('selected');
                    if (opt.dataset.sound === appState.currentSpeedSound) opt.classList.add('selected');
                });
            }

            // ==================== REGION ====================
            function selectRegion(reg) {
                appState.region = reg;
                regionSG.classList.toggle('selected', reg === 'sg');
                regionIN.classList.toggle('selected', reg === 'in');
                regionDisplay.innerHTML = `<i class="fas fa-map-marker-alt"></i><span>${reg === 'sg' ? 'Singapore' : 'India'}</span>`;
                appState.speedLimit = speedLimitDB[reg].default;
                speedLimitValueEl.textContent = appState.speedLimit;
                saveSettings();
                showNotification(`Region: ${reg === 'sg' ? 'Singapore' : 'India'}`);
            }

            // ==================== SETTINGS ====================
            function updateCameraDistance() {
                appState.cameraAlertDistance = parseInt(cameraDistanceSlider.value);
                cameraDistanceValue.textContent = appState.cameraAlertDistance + 'm';
                saveSettings();
            }
            function toggleCameraAlerts() { appState.cameraAlertsEnabled = cameraAlertsToggle.checked; saveSettings(); }
            function toggleSpeedAlerts() { appState.speedAlertsEnabled = speedAlertsToggle.checked; saveSettings(); }
            function updateCameraDistanceDisplay() {
                cameraDistanceSlider.value = appState.cameraAlertDistance;
                cameraDistanceValue.textContent = appState.cameraAlertDistance + 'm';
                cameraAlertsToggle.checked = appState.cameraAlertsEnabled;
                speedAlertsToggle.checked = appState.speedAlertsEnabled;
            }
            function updateRegionUI() {
                const sg = appState.region === 'sg';
                regionSG.classList.toggle('selected', sg);
                regionIN.classList.toggle('selected', !sg);
                regionDisplay.innerHTML = `<i class="fas fa-map-marker-alt"></i><span>${sg ? 'Singapore' : 'India'}</span>`;
            }

            // ==================== ALERT HANDLERS ====================
            function closeCameraAlertHandler() { hideModal(cameraAlertModal); appState.cameraAlertActive = false; }
            function closeSpeedAlertHandler() { hideModal(speedAlertModal); appState.speedAlertActive = false; }

            // ==================== HISTORY ====================
            function saveTripToHistory() {
                const trip = {
                    id: Date.now(),
                    date: new Date().toLocaleDateString('en-SG', { day:'2-digit', month:'2-digit', year:'2-digit', hour:'2-digit', minute:'2-digit' }),
                    distance: appState.distance.toFixed(2) + ' km',
                    duration: timeEl.textContent,
                    overspeed: overspeedEl.textContent,
                    region: appState.region
                };
                appState.tripHistory.unshift(trip);
                if (appState.tripHistory.length > 50) appState.tripHistory = appState.tripHistory.slice(0,50);
                localStorage.setItem('motoDashHistory', JSON.stringify(appState.tripHistory));
            }
            function loadTripHistory() { const s = localStorage.getItem('motoDashHistory'); if(s) appState.tripHistory = JSON.parse(s); }
            function showHistory() { loadHistoryTable(); showModal(historyModal); }
            function loadHistoryTable() {
                historyTableBody.innerHTML = '';
                if (appState.tripHistory.length === 0) { emptyHistory.style.display = 'block'; return; }
                emptyHistory.style.display = 'none';
                appState.tripHistory.forEach(t => {
                    const r = document.createElement('tr');
                    r.innerHTML = `<td>${t.date}</td><td>${t.distance}</td><td>${t.duration}</td><td>${t.overspeed}</td>`;
                    historyTableBody.appendChild(r);
                });
            }
            function downloadHistory() {
                const data = JSON.stringify(appState.tripHistory, null, 2);
                const blob = new Blob([data], {type:'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `motodash-${appState.region}-history-${new Date().toISOString().slice(0,10)}.json`;
                a.click(); URL.revokeObjectURL(url); showNotification('History downloaded');
            }
            function uploadHistory(e) {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(ev) {
                    try {
                        const h = JSON.parse(ev.target.result);
                        if (Array.isArray(h)) { appState.tripHistory = h.concat(appState.tripHistory).slice(0,50); localStorage.setItem('motoDashHistory', JSON.stringify(appState.tripHistory)); loadHistoryTable(); showNotification('History uploaded'); }
                    } catch { showNotification('Invalid file'); }
                };
                reader.readAsText(file); e.target.value = '';
            }
            function clearHistory() { if (confirm('Clear all trip history?')) { appState.tripHistory = []; localStorage.removeItem('motoDashHistory'); loadHistoryTable(); showNotification('History cleared'); } }

            // ==================== SETTINGS STORAGE ====================
            function saveSettings() {
                localStorage.setItem('motoDashSettings', JSON.stringify({
                    region: appState.region,
                    cameraSound: appState.currentCameraSound,
                    speedSound: appState.currentSpeedSound,
                    cameraDistance: appState.cameraAlertDistance,
                    cameraAlerts: appState.cameraAlertsEnabled,
                    speedAlerts: appState.speedAlertsEnabled
                }));
            }
            function loadSettings() {
                const s = localStorage.getItem('motoDashSettings');
                if (s) {
                    const set = JSON.parse(s);
                    appState.region = set.region || 'sg';
                    appState.currentCameraSound = set.cameraSound || 'camera2';
                    appState.currentSpeedSound = set.speedSound || 'speed2';
                    appState.cameraAlertDistance = set.cameraDistance || 500;
                    appState.cameraAlertsEnabled = set.cameraAlerts !== false;
                    appState.speedAlertsEnabled = set.speedAlerts !== false;
                } else {
                    appState.currentCameraSound = 'camera2';
                    appState.currentSpeedSound = 'speed2';
                }
            }

            // ==================== WAKE LOCK ====================
            async function requestWakeLock() {
                try {
                    if ('wakeLock' in navigator) {
                        if (appState.wakeLock) await appState.wakeLock.release(); // release old if any
                        appState.wakeLock = await navigator.wakeLock.request('screen');
                        document.addEventListener('visibilitychange', async () => {
                            if (document.visibilityState === 'visible' && appState.wakeLock === null && appState.isTripActive) {
                                appState.wakeLock = await navigator.wakeLock.request('screen');
                            }
                        });
                    }
                } catch (err) { console.log('Wake Lock error'); }
            }

            // ==================== MODAL HELPERS ====================
            function showModal(m) { m.style.display = 'flex'; }
            function hideModal(m) { m.style.display = 'none'; }

            // ==================== NOTIFICATION ====================
            function showNotification(msg) {
                const n = document.createElement('div');
                n.style.cssText = `position:fixed; bottom:calc(15vh + 30px); right:20px; background:var(--accent-blue); color:white; padding:12px 24px; border-radius:30px; font-weight:500; z-index:10000; animation:slideIn 0.3s ease; box-shadow:0 0 15px rgba(59,130,246,0.5); max-width:300px;`;
                n.textContent = msg;
                document.body.appendChild(n);
                setTimeout(() => n.remove(), 3000);
            }

            // ==================== EVENT LISTENERS ====================
            function initEventListeners() {
                startBtn.addEventListener('click', () => showModal(startModal));
                stopBtn.addEventListener('click', showStopConfirmation);
                historyBtn.addEventListener('click', showHistory);
                settingsBtn.addEventListener('click', () => showModal(settingsModal));

                closeStartModal.addEventListener('click', () => hideModal(startModal));
                closeStopModal.addEventListener('click', () => hideModal(stopModal));
                closeSettingsModal.addEventListener('click', () => hideModal(settingsModal));
                closeHistoryModal.addEventListener('click', () => hideModal(historyModal));
                closeCameraAlert.addEventListener('click', closeCameraAlertHandler);
                closeSpeedAlert.addEventListener('click', closeSpeedAlertHandler);

                confirmStart.addEventListener('click', startTrip);
                cancelStart.addEventListener('click', () => hideModal(startModal));
                confirmStop.addEventListener('click', stopTrip);
                cancelStop.addEventListener('click', () => hideModal(stopModal));

                downloadHistoryBtn.addEventListener('click', downloadHistory);
                uploadHistoryBtn.addEventListener('click', () => historyFileInput.click());
                clearHistoryBtn.addEventListener('click', clearHistory);
                historyFileInput.addEventListener('change', uploadHistory);

                cameraDistanceSlider.addEventListener('input', updateCameraDistance);
                cameraAlertsToggle.addEventListener('change', toggleCameraAlerts);
                speedAlertsToggle.addEventListener('change', toggleSpeedAlerts);
                
                regionSG.addEventListener('click', () => selectRegion('sg'));
                regionIN.addEventListener('click', () => selectRegion('in'));

                // FIXED: sound selection
                document.querySelectorAll('.sound-option').forEach(opt => {
                    opt.addEventListener('click', function(e) {
                        if (e.target.closest('.test-btn')) return;
                        selectSound(this);
                    });
                });
                document.querySelectorAll('.test-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const s = this.closest('.sound-option').dataset.sound;
                        playSound(s);
                    });
                });

                document.addEventListener('contextmenu', e => e.preventDefault());
            }

            // ==================== INIT ====================
            document.addEventListener('DOMContentLoaded', function() {
                initAudio();
                loadTripHistory();
                loadSettings();
                requestWakeLock(); // initial lock (will be re-requested on trip start)
                initEventListeners();
                applySettingsToUI();
                updateRegionUI();
                updateCameraDistanceDisplay();
                generateCameraLocations();
                startGPS();
                startMonitoring();
            });

            window.addEventListener('beforeunload', () => {
                if (appState.watchId) navigator.geolocation.clearWatch(appState.watchId);
            });
        })();
    </script>
</body>
</html>
