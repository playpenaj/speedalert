<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Speed Guard Live</title>
    <style>
        :root {
            --safe-top: env(safe-area-inset-top, 20px);
            --neon-green: #00ff00;
            --danger-red: #ff4444;
        }

        * { box-sizing: border-box; touch-action: manipulation; }
        body { 
            font-family: -apple-system, system-ui, sans-serif;
            background: #000; color: white; margin: 0; height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
            padding-top: var(--safe-top);
        }

        #gps-status { font-size: 0.7rem; font-weight: bold; padding: 4px 10px; border-radius: 10px; margin-bottom: 5px; text-transform: uppercase; }
        .gps-searching { color: #ff9800; background: rgba(255, 152, 0, 0.2); }
        .gps-active { color: var(--neon-green); background: rgba(0, 255, 0, 0.2); }

        #custom-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 2000; justify-content: center; align-items: center;
        }
        .modal-box {
            background: #1a1a1a; width: 85%; max-width: 400px; padding: 25px;
            border-radius: 20px; border: 1px solid #333; text-align: center;
        }
        .modal-btns { display: flex; gap: 10px; margin-top: 20px; }
        .modal-btn { flex: 1; padding: 12px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; }

        .danger { animation: blink-red 0.3s infinite; }
        @keyframes blink-red { 0%, 100% { background: #000; } 50% { background: #600; } }
        #slow-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,0,0,0.8); z-index: 1000; 
            justify-content: center; align-items: center; font-size: 3rem; font-weight: 900;
        }

        .nav-tabs { display: flex; background: #111; border-bottom: 1px solid #333; margin-top: 10px; }
        .tab-btn { flex: 1; padding: 15px; border: none; background: none; color: #888; font-weight: bold; font-size: 0.9rem; }
        .tab-btn.active { color: var(--neon-green); border-bottom: 3px solid var(--neon-green); }

        .tab-content { flex: 1; display: none; padding: 15px; overflow-y: auto; }
        .tab-content.active { display: flex; flex-direction: column; align-items: center; justify-content: space-around; }

        #speed { font-size: 45vw; line-height: 0.9; margin: 0; font-weight: 900; }
        .limit-display { width: 100px; height: 100px; border: 8px solid #f00; border-radius: 50%; background: #fff; color: #000; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 2.5rem; }
        #timer-display { font-family: monospace; font-size: 1.5rem; color: var(--neon-green); }
        
        .btn-main { padding: 18px; border-radius: 50px; border: none; font-weight: bold; font-size: 1.1rem; width: 90%; margin: 10px 0; }
        #startBtn { background: var(--neon-green); color: #000; }
        #stopBtn { background: var(--danger-red); color: #fff; display: none; }

        /* Settings Area */
        .settings-card { background: #111; padding: 15px; border-radius: 12px; border: 1px solid #333; margin-bottom: 15px; width: 100%; text-align: left; }
        .settings-card h4 { margin: 0 0 12px 0; color: var(--neon-green); font-size: 0.9rem; text-transform: uppercase; }
        .setting-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
        select { background: #222; color: white; border: 1px solid #444; padding: 8px; border-radius: 5px; font-size: 0.8rem; }
        
        .log-actions { width: 100%; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .btn-small { padding: 10px; border-radius: 8px; border: none; font-weight: bold; font-size: 0.7rem; color: white; background: #222; }
        table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
        th { text-align: left; color: var(--neon-green); border-bottom: 1px solid #333; padding: 8px; }
        td { padding: 10px 8px; border-bottom: 1px solid #222; }
    </style>
</head>
<body>

    <div id="custom-modal">
        <div class="modal-box">
            <h3 id="modal-title" style="margin-top:0">Confirm</h3>
            <p id="modal-msg" style="color:#aaa; font-size:0.9rem"></p>
            <div class="modal-btns">
                <button class="modal-btn" style="background:#333; color:white" onclick="closeModal(false)">Cancel</button>
                <button class="modal-btn" id="modal-confirm-btn" style="background:var(--neon-green); color:black">Yes, Proceed</button>
            </div>
        </div>
    </div>

    <div id="slow-overlay">SLOW DOWN</div>

    <div class="nav-tabs">
        <button class="tab-btn active" onclick="openTab('monitor')">Monitor</button>
        <button class="tab-btn" onclick="openTab('logs')">Ride Logs</button>
    </div>

    <div id="monitor" class="tab-content active">
        <div id="gps-status" class="gps-searching">GPS: Searching...</div>
        <div style="text-align: center;">
            <div id="timer-display">00:00:00</div>
            <div id="auto-stop-timer" style="color:#ff9800; font-size:0.8rem; visibility:hidden">Idle: 05:00</div>
        </div>
        <div class="limit-display" id="roadLimit">--</div>
        <h1 id="speed">0</h1>
        <div style="color:#888; letter-spacing: 2px;">KM/H</div>
        <button id="startBtn" class="btn-main" onclick="askStart()">START JOURNEY</button>
        <button id="stopBtn" class="btn-main" onclick="askStop()">END JOURNEY</button>
    </div>

    <div id="logs" class="tab-content">
        <div class="settings-card">
            <h4>‚öôÔ∏è Alarm Settings</h4>
            <div class="setting-row">
                <label style="font-size: 0.8rem; color:#ccc;">Alarm Tone:</label>
                <select id="soundSelect">
                    <option value="industrial">Sharp Industrial</option>
                    <option value="pulse">Pulse Warning</option>
                </select>
            </div>
            <button onclick="testAlarm()" class="btn-small" style="width:100%; background:#444;">üîä TEST SELECTED ALARM</button>
        </div>

        <div class="settings-card" style="margin-top:0">
            <h4>üìñ Read Me</h4>
            <ul style="padding-left:15px; margin:0; font-size:0.75rem; color:#aaa; line-height:1.4;">
                <li><strong>Live Limits:</strong> Fetched from OpenStreetMap as you drive.</li>
                <li><strong>Sound:</strong> You must click START to unlock audio in your browser.</li>
                <li><strong>Privacy:</strong> Data is 100% offline on your device.</li>
            </ul>
        </div>

        <div class="log-actions">
            <button onclick="askExport()" class="btn-small" style="background:#0055ff;">EXPORT</button>
            <button onclick="document.getElementById('fileInput').click()" class="btn-small" style="background:#00aa00;">IMPORT</button>
            <button onclick="askClear()" class="btn-small" style="background:#aa0000;">WIPE</button>
        </div>
        <input type="file" id="fileInput" hidden onchange="importCSV(event)">
        <table>
            <thead><tr><th>DATE/TIME</th><th>OVER</th><th>KM/MAX</th></tr></thead>
            <tbody id="tripLogs"></tbody>
        </table>
    </div>

    <script>
        let audioCtx, watchID, timerInterval, limitInterval, rideStart, overspeedSec = 0, idleTime = 0;
        let currentLimit = 50, speeds = [], totalDist = 0, lastPos = null;
        let tripHistory = JSON.parse(localStorage.getItem('speedGuardV6') || '[]');

        function openTab(name) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(name).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        function showModal(title, msg, onConfirm) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-msg').innerText = msg;
            const btn = document.getElementById('modal-confirm-btn');
            btn.onclick = () => { onConfirm(); closeModal(); };
            document.getElementById('custom-modal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('custom-modal').style.display = 'none'; }

        function playAlarm() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const type = document.getElementById('soundSelect').value;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            if (type === 'industrial') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(1200, audioCtx.currentTime);
                gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
                osc.start(); osc.stop(audioCtx.currentTime + 0.15);
            } else {
                osc.type = 'square';
                osc.frequency.setValueAtTime(400, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.2);
                gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
                osc.start(); osc.stop(audioCtx.currentTime + 0.2);
            }
            
            osc.connect(gain); gain.connect(audioCtx.destination);
        }

        function testAlarm() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            playAlarm();
        }

        async function fetchSpeedLimit(lat, lon) {
            const query = `[out:json];way(around:35, ${lat}, ${lon})[maxspeed];out tags;`;
            try {
                const response = await fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`);
                const data = await response.json();
                if (data.elements && data.elements.length > 0) {
                    let limit = parseInt(data.elements[0].tags.maxspeed);
                    if (!isNaN(limit)) {
                        currentLimit = limit;
                        document.getElementById('roadLimit').innerText = currentLimit;
                    }
                }
            } catch (e) { console.error("Limit Fetch Error", e); }
        }

        function askStart() { showModal("Start Journey?", "Alarm and GPS tracking will activate.", startRide); }
        function askStop() { showModal("End Journey?", "Save data and reset screen?", () => stopRide(false)); }

        function startRide() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            rideStart = Date.now(); speeds = []; totalDist = 0; lastPos = null; overspeedSec = 0; idleTime = 0;
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'block';

            timerInterval = setInterval(() => {
                const diff = Date.now() - rideStart;
                document.getElementById('timer-display').innerText = new Date(diff).toISOString().substr(11, 8);
                if (idleTime >= 300) stopRide(true);
            }, 1000);

            watchID = navigator.geolocation.watchPosition((p) => {
                const gpsEl = document.getElementById('gps-status');
                gpsEl.innerText = "GPS: Active"; gpsEl.className = "gps-active";

                const rawKmh = Math.round((p.coords.speed || 0) * 3.6);
                const kmh = rawKmh > 0 ? rawKmh + 5 : 0;
                document.getElementById('speed').innerText = kmh;
                
                if (kmh > currentLimit) {
                    document.body.classList.add('danger'); overspeedSec++;
                    document.getElementById('slow-overlay').style.display = 'flex';
                    playAlarm();
                } else {
                    document.body.classList.remove('danger'); document.getElementById('slow-overlay').style.display = 'none';
                }
                
                if (kmh < 2) idleTime++; else {
                    idleTime = 0;
                    if (!limitInterval || Date.now() - limitInterval > 20000) {
                        fetchSpeedLimit(p.coords.latitude, p.coords.longitude);
                        limitInterval = Date.now();
                    }
                }
                lastPos = {lat: p.coords.latitude, lon: p.coords.longitude}; if (kmh > 5) speeds.push(kmh);
            }, null, { enableHighAccuracy: true });
        }

        function stopRide(auto) {
            navigator.geolocation.clearWatch(watchID); clearInterval(timerInterval);
            const trip = { 
                dt: new Date().toLocaleDateString('en-GB') + ' ' + new Date().toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'}),
                dur: document.getElementById('timer-display').innerText, dst: totalDist.toFixed(2), 
                mx: speeds.length ? Math.max(...speeds) : 0, ov: (overspeedSec / 60).toFixed(1)
            };
            tripHistory.push(trip);
            localStorage.setItem('speedGuardV6', JSON.stringify(tripHistory));
            renderLogs();
            
            document.getElementById('timer-display').innerText = "00:00:00";
            document.getElementById('speed').innerText = "0";
            document.getElementById('roadLimit').innerText = "--";
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('startBtn').style.display = 'block';
            document.getElementById('gps-status').innerText = "GPS: Searching...";
            document.getElementById('gps-status').className = "gps-searching";
        }

        function renderLogs() {
            document.getElementById('tripLogs').innerHTML = [...tripHistory].reverse().map(t => `
                <tr><td>${t.dt}</td><td style="color:#f44">${t.ov}m</td><td>${t.dst}k / ${t.mx}</td></tr>
            `).join('');
        }

        function askExport() { showModal("Export CSV?", "Save logs to your device.", () => {
            let csv = "DateTime,Duration,Dist,Max,Overspeed\n";
            tripHistory.forEach(t => csv += `${t.dt},${t.dur},${t.dst},${t.mx},${t.ov}\n`);
            const b = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = `logs.csv`; a.click();
        }); }

        function askClear() { showModal("Wipe All?", "Delete history permanently?", () => { tripHistory = []; localStorage.removeItem('speedGuardV6'); renderLogs(); }); }

        function importCSV(e) {
            const reader = new FileReader();
            reader.onload = (ev) => {
                ev.target.result.split('\n').slice(1).forEach(r => {
                    const c = r.split(',');
                    if (c.length >= 5) tripHistory.push({ dt: c[0], dur: c[1], dst: c[2], mx: c[3], ov: c[4] });
                });
                localStorage.setItem('speedGuardV6', JSON.stringify(tripHistory)); renderLogs();
            };
            reader.readAsText(e.target.files[0]);
        }
        window.onload = renderLogs;
    </script>
</body>
</html>
