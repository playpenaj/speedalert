<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Speed Guard SG/IN</title>
    <style>
        * { box-sizing: border-box; touch-action: manipulation; }
        body { 
            font-family: -apple-system, system-ui, sans-serif;
            display: flex; flex-direction: column; align-items: center; 
            height: 100vh; width: 100vw; margin: 0; padding: 10px;
            background: #000; color: white; overflow: hidden;
        }
        .danger { background: #aa0000 !important; animation: pulse 0.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        
        /* Connection Status Bar */
        #signal-bar { 
            width: 100%; display: flex; justify-content: space-between; 
            font-size: 0.7rem; padding: 10px; background: #111; border-radius: 10px;
            margin-bottom: 10px; border: 1px solid #222;
        }
        .status-connected { color: #00ff00; font-weight: bold; }
        .status-disconnected { color: #ff4444; font-weight: bold; }

        .main-display { flex: 2; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #speed { font-size: 35vw; line-height: 1; margin: 0; font-weight: 900; }
        
        .limit-display {
            width: 100px; height: 100px; border: 8px solid #ff0000; border-radius: 50%;
            background: white; color: black; display: flex; flex-direction: column;
            align-items: center; justify-content: center; font-weight: bold;
        }
        #roadLimit { font-size: 2.2rem; }

        .controls { flex: 1.2; display: flex; flex-direction: column; align-items: center; gap: 8px; width: 100%; }
        button { padding: 15px 25px; font-size: 0.9rem; font-weight: bold; border: none; border-radius: 50px; cursor: pointer; text-transform: uppercase; width: 80%; }
        #startBtn { background: #00ff00; color: #000; }
        .secondary-btn { background: #222; color: #fff; border: 1px solid #444; width: auto; }

        .log-container { 
            flex: 1; width: 100%; background: #0a0a0a; border-radius: 15px; 
            padding: 10px; overflow-y: auto; font-family: monospace; font-size: 0.7rem; border: 1px solid #333;
        }
        .alert-log { color: #ff4444; padding: 4px 0; border-bottom: 1px solid #200; }
    </style>
</head>
<body>

    <div id="signal-bar">
        <span>GPS: <span id="sig-text" class="status-disconnected">NO CONNECTION</span></span>
        <span>ACCURACY: <span id="acc-val">--</span>m</span>
    </div>

    <div class="main-display">
        <div class="limit-display" onclick="manualLimit()">
            <span style="font-size:0.5rem">LIMIT</span>
            <span id="roadLimit">50</span>
        </div>
        <h1 id="speed">0</h1>
        <div style="color:#888; letter-spacing: 2px;">KM/H</div>
    </div>

    <div class="controls">
        <button id="startBtn">Start Monitor</button>
        <div style="display:flex; gap:10px;">
            <button id="dimBtn" class="secondary-btn" style="display:none">Dim</button>
            <button id="clearBtn" class="secondary-btn">Clear Logs</button>
        </div>
    </div>

    <div class="log-container" id="logs"></div>

    <script>
        const speedDisplay = document.getElementById('speed');
        const roadLimitDisplay = document.getElementById('roadLimit');
        const accVal = document.getElementById('acc-val');
        const sigText = document.getElementById('sig-text');
        const startBtn = document.getElementById('startBtn');
        const logsDiv = document.getElementById('logs');
        
        let audioCtx = null, alarmInterval = null, currentLimit = 50, lastApiCall = 0;
        let connectionTimeout = null;

        function manualLimit() {
            const n = prompt("Set Limit:", currentLimit);
            if (n && !isNaN(n)) { currentLimit = parseInt(n); roadLimitDisplay.innerText = currentLimit; }
        }

        async function fetchLimit(lat, lon) {
            if (Date.now() - lastApiCall < 15000) return;
            lastApiCall = Date.now();
            try {
                const res = await fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(`[out:json];way(around:50,${lat},${lon})[maxspeed];out tags;`)}`);
                const data = await res.json();
                if (data.elements?.[0]?.tags?.maxspeed) {
                    currentLimit = parseInt(data.elements[0].tags.maxspeed);
                    roadLimitDisplay.innerText = currentLimit;
                }
            } catch (e) {}
        }

        function playBeep() {
            if (audioCtx) {
                let o = audioCtx.createOscillator(), g = audioCtx.createGain();
                o.type = "square"; o.frequency.value = 1400;
                g.gain.setTargetAtTime(0.2, audioCtx.currentTime, 0.01);
                o.connect(g); g.connect(audioCtx.destination);
                o.start(); o.stop(audioCtx.currentTime + 0.12);
            }
            if (navigator.vibrate) navigator.vibrate(200);
        }

        function setStatus(connected) {
            if (connected) {
                sigText.innerText = "CONNECTED";
                sigText.className = "status-connected";
            } else {
                sigText.innerText = "NO CONNECTION";
                sigText.className = "status-disconnected";
                speedDisplay.innerText = "0";
            }
        }

        startBtn.onclick = () => {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (navigator.wakeLock) navigator.wakeLock.request('screen');
            
            navigator.geolocation.watchPosition((p) => {
                // Clear the timeout - we are getting data
                clearTimeout(connectionTimeout);
                setStatus(true);

                const acc = Math.round(p.coords.accuracy);
                accVal.innerText = acc;
                
                const kmh = Math.round((p.coords.speed || 0) * 3.6);
                speedDisplay.innerText = kmh;
                fetchLimit(p.coords.latitude, p.coords.longitude);

                if (kmh > currentLimit) {
                    document.body.classList.add('danger');
                    if (!alarmInterval) {
                        alarmInterval = setInterval(playBeep, 500);
                        const div = document.createElement('div');
                        div.className = 'alert-log';
                        div.innerHTML = `[${new Date().toLocaleTimeString()}] ALERT: ${kmh}km/h (${currentLimit})`;
                        logsDiv.prepend(div);
                    }
                } else {
                    document.body.classList.remove('danger');
                    clearInterval(alarmInterval); alarmInterval = null;
                }

                // If no update for 5 seconds, consider disconnected
                connectionTimeout = setTimeout(() => setStatus(false), 5000);

            }, (err) => {
                setStatus(false);
            }, { enableHighAccuracy: true });

            startBtn.style.display = 'none';
            document.getElementById('dimBtn').style.display = 'block';
        };

        document.getElementById('clearBtn').onclick = () => logsDiv.innerHTML = '';
        document.getElementById('dimBtn').onclick = () => {
            document.body.style.filter = document.body.style.filter === "brightness(0.2)" ? "brightness(1)" : "brightness(0.2)";
        };
    </script>
</body>
</html>
