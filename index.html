<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Speed Guard Pro</title>
    
    <link rel="apple-touch-icon" href="https://img.icons8.com/neon/256/speedometer.png">
    
    <style>
        :root {
            --safe-top: env(safe-area-inset-top, 20px);
            --neon-green: #00ff00;
            --danger-red: #ff4444;
            --camera-yellow: #ffcc00;
            --bg-dark: #0a0a0a;
            --card-bg: #161616;
        }

        * { box-sizing: border-box; touch-action: manipulation; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-dark); color: white; margin: 0; height: 100vh; overflow: hidden;
            display: flex; flex-direction: column; padding-top: var(--safe-top);
        }

        /* CUSTOM MODAL */
        #modal-overlay {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95);
            z-index: 5000; justify-content: center; align-items: center; padding: 20px;
        }
        .modal-box {
            background: #1a1a1a; border: 1px solid #333; border-radius: 24px;
            width: 100%; max-width: 340px; padding: 25px; text-align: left;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        }
        .modal-btns { display: flex; gap: 10px; margin-top: 20px; }
        .modal-btn { flex: 1; padding: 14px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; }

        #camera-alert {
            display: none; width: 100%; background: var(--camera-yellow); color: #000;
            padding: 15px; text-align: center; font-weight: 900; font-size: 1.2rem;
            position: fixed; top: 0; left: 0; z-index: 3000; border-bottom: 2px solid #000;
        }

        .nav-tabs { display: flex; background: #1a1a1a; border-bottom: 1px solid #333; z-index: 2000; }
        .tab-btn { flex: 1; padding: 20px; border: none; background: none; color: #555; font-weight: bold; font-size: 0.85rem; letter-spacing: 1px; }
        .tab-btn.active { color: var(--neon-green); border-bottom: 3px solid var(--neon-green); }

        .tab-content { flex: 1; display: none; padding: 15px; overflow-y: auto; }
        .tab-content.active { display: flex; flex-direction: column; align-items: center; }

        .dash-grid { display: grid; grid-template-columns: 1fr 1fr; width: 100%; gap: 10px; margin-bottom: 10px; }
        .dash-item { background: var(--card-bg); padding: 12px; border-radius: 15px; text-align: center; border: 1px solid #222; }
        .dash-label { font-size: 0.6rem; color: #666; text-transform: uppercase; letter-spacing: 1px; }
        .dash-val { font-size: 1.2rem; font-weight: bold; display: block; margin-top: 4px; }

        #speed { font-size: 38vw; line-height: 0.8; margin: 5px 0; font-weight: 900; font-variant-numeric: tabular-nums; }
        .limit-display { width: 90px; height: 90px; border: 7px solid #f00; border-radius: 50%; background: #fff; color: #000; display: flex; align-items: center; justify-content: center; font-weight: 900; font-size: 2.2rem; }
        
        .card { background: var(--card-bg); padding: 18px; border-radius: 15px; border: 1px solid #222; margin-bottom: 15px; width: 100%; }
        table { width: 100%; border-collapse: collapse; font-size: 0.7rem; }
        th { text-align: left; color: var(--neon-green); border-bottom: 1px solid #333; padding: 10px 5px; }
        td { padding: 12px 5px; border-bottom: 1px solid #1a1a1a; }

        .btn-main { padding: 20px; border-radius: 50px; border: none; font-weight: 800; font-size: 1.2rem; width: 92%; margin-top: 10px; cursor: pointer; transition: 0.2s; }
        #info-trigger { background: #222; border: none; color: #888; border-radius: 50%; width: 24px; height: 24px; font-size: 0.8rem; cursor: pointer; margin-left: 10px; }
        
        #slow-overlay { display: none; position: fixed; inset: 0; background: rgba(255,0,0,0.9); z-index: 2500; justify-content: center; align-items: center; font-size: 3.5rem; font-weight: 900; pointer-events: none; }
        .danger { animation: blink-red 0.4s infinite; }
        @keyframes blink-red { 0%, 100% { background: #000; } 50% { background: #300; } }
    </style>
</head>
<body>

    <div id="modal-overlay">
        <div class="modal-box">
            <h3 id="modal-title" style="margin-top:0; color:var(--neon-green);"></h3>
            <div id="modal-body"></div>
            <div class="modal-btns">
                <button id="modal-cancel-btn" class="modal-btn" style="background:#333; color:white;" onclick="closeModal()">CANCEL</button>
                <button id="modal-confirm-btn" class="modal-btn" style="background:var(--neon-green); color:black;">OK</button>
            </div>
        </div>
    </div>

    <div id="camera-alert">⚠️ CAMERA DETECTED</div>
    <div id="slow-overlay">SLOW DOWN</div>

    <div class="nav-tabs">
        <button id="mon-tab" class="tab-btn active" onclick="openTab('monitor')">DASHBOARD</button>
        <button id="log-tab" class="tab-btn" onclick="openTab('logs')">HISTORY</button>
    </div>

    <div id="monitor" class="tab-content active">
        <div style="display:flex; align-items:center; margin-bottom:10px;">
            <span style="font-size:0.7rem; color:#666; text-transform:uppercase; letter-spacing:2px;">Live Guard</span>
            <button id="info-trigger" onclick="showReadme()">ⓘ</button>
        </div>
        
        <div class="dash-grid">
            <div class="dash-item"><span class="dash-label">Duration</span><span id="dash-duration" class="dash-val" style="color:var(--neon-green)">00:00:00</span></div>
            <div class="dash-item"><span class="dash-label">Distance</span><span id="dash-dist" class="dash-val">0.0 km</span></div>
        </div>

        <div class="limit-display" id="roadLimit">60</div>
        <h1 id="speed">0</h1>
        <div style="color:#444; font-size: 0.8rem; letter-spacing: 4px; font-weight: bold; margin-bottom: 10px;">KM/H</div>
        
        <button id="startBtn" class="btn-main" style="background:var(--neon-green); color:#000;" onclick="handleStart()">START JOURNEY</button>
        <button id="stopBtn" class="btn-main" style="background:var(--danger-red); color:#fff; display:none;" onclick="handleStop()">END JOURNEY</button>
        
        <div id="gps-status" style="font-size:0.55rem; color:#444; margin-top:15px;">SCANNING ROAD DATA...</div>
    </div>

    <div id="logs" class="tab-content">
        <div class="card">
            <div style="display:grid; grid-template-columns: repeat(4, 1fr); text-align:center;">
                <div><span class="dash-val" id="sum-dist">0</span><span class="dash-label">KM</span></div>
                <div><span class="dash-val" id="sum-max">0</span><span class="dash-label">MAX</span></div>
                <div><span class="dash-val" id="sum-rides">0</span><span class="dash-label">RIDES</span></div>
                <div><span class="dash-val" id="sum-time">0</span><span class="dash-label">MINS</span></div>
            </div>
        </div>

        <div style="display: flex; gap: 8px; width: 100%; margin-bottom: 15px;">
            <button onclick="handleExport()" style="flex:1; background:#0055ff; padding:12px; border:none; border-radius:10px; color:white; font-weight:bold; font-size:0.7rem;">EXPORT</button>
            <button onclick="document.getElementById('csvUpload').click()" style="flex:1; background:#222; border:1px solid #444; padding:12px; border-radius:10px; color:white; font-weight:bold; font-size:0.7rem;">UPLOAD</button>
            <input type="file" id="csvUpload" style="display:none" accept=".csv" onchange="handleFileUpload(event)">
        </div>
        
        <button onclick="handleWipe()" style="background:none; border:none; color:#555; font-size:0.6rem; text-decoration:underline; width:100%;">WIPE ALL HISTORY</button>

        <table>
            <thead><tr><th>DATE</th><th>DUR</th><th>KM</th><th>MAX</th><th>OVER</th><th>MAP</th></tr></thead>
            <tbody id="tripLogs"></tbody>
        </table>
    </div>

    <script>
        let audioCtx, watchID, timerInterval, heartbeat, wakeLock = null;
        let rideStart, speeds = [], totalDist = 0, overspeedSec = 0;
        let route = [], lastLat, lastLon, lastTime;
        let currentLimit = 60, cameraDetected = false;
        let tripHistory = JSON.parse(localStorage.getItem('SpeedGuardFinalV13') || '[]');

        function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }
        
        function showModal(title, content, onConfirm = null) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-body').innerHTML = typeof content === 'string' ? `<p style="color:#aaa; font-size:0.9rem;">${content}</p>` : '';
            if (typeof content === 'object') document.getElementById('modal-body').appendChild(content);
            const confirmBtn = document.getElementById('modal-confirm-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');
            if (onConfirm) { confirmBtn.style.display = 'block'; confirmBtn.onclick = () => { onConfirm(); closeModal(); }; cancelBtn.innerText = "CANCEL"; }
            else { confirmBtn.style.display = 'none'; cancelBtn.innerText = "CLOSE"; }
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function showReadme() {
            const div = document.createElement('div');
            div.style.fontSize = '0.8rem'; div.style.color = '#ccc';
            div.innerHTML = `
                <p><b>Installation:</b> Tap "Add to Home Screen" in your browser menu to use as a full-screen app.</p>
                <p><b>Camera Radar:</b> Scans for speed, red-light, and check-point cameras in a 750m radius.</p>
                <li><b>Smart Wake:</b> Screen stays on only while journey is active.</li>
                <li><b>Route Map:</b> Click 'Route' in history to see your specific path.</li>
            `;
            showModal("Read Me", div);
        }

        function handleStart() { showModal("Start Journey", "Dash will lock screen to ON. Audio alerts enabled.", startRide); }
        function handleStop() { showModal("End Journey", "Save trip data and release screen lock?", stopRide); }
        function handleWipe() { showModal("Wipe Data", "Permanently delete all logs?", () => { tripHistory = []; localStorage.removeItem('SpeedGuardFinalV13'); renderLogs(); }); }
        function handleExport() { showModal("Export", "Save logs to CSV?", exportCSV); }

        async function requestWakeLock() {
            try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
        }

        function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                heartbeat = audioCtx.createOscillator();
                let gain = audioCtx.createGain();
                heartbeat.frequency.setValueAtTime(20, audioCtx.currentTime);
                gain.gain.setValueAtTime(0.001, audioCtx.currentTime);
                heartbeat.connect(gain); gain.connect(audioCtx.destination);
                heartbeat.start();
            }
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        function playAlarm(freq = 1000) {
            initAudio();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'square';
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setTargetAtTime(0.15, audioCtx.currentTime, 0.01);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + 0.2);
        }

        async function updateRoadData(lat, lon) {
            // Expanded query to catch ALL camera variations
            const query = `[out:json];(node["highway"~"speed_camera|red_light|check_speed|violation_camera"](around:750,${lat},${lon});way["maxspeed"](around:50,${lat},${lon}););out tags;`;
            try {
                const res = await fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`);
                const data = await res.json();
                const cam = data.elements.find(e => e.tags && (e.tags.highway || '').match(/camera|light/));
                if (cam) { 
                    if (!cameraDetected) playAlarm(1500); 
                    document.getElementById('camera-alert').style.display = 'block'; 
                    cameraDetected = true; 
                } else { 
                    document.getElementById('camera-alert').style.display = 'none'; 
                    cameraDetected = false; 
                }
                const way = data.elements.find(e => e.tags && e.tags.maxspeed);
                if (way) { currentLimit = parseInt(way.tags.maxspeed) || 60; document.getElementById('roadLimit').innerText = currentLimit; }
            } catch (e) {}
        }

        function startRide() {
            initAudio(); requestWakeLock();
            rideStart = Date.now(); lastTime = Date.now();
            speeds = []; totalDist = 0; overspeedSec = 0; route = [];
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'block';
            document.getElementById('gps-status').innerText = "GPS: ACTIVE | LOCK: ON";

            watchID = navigator.geolocation.watchPosition((p) => {
                let s = p.coords.speed || 0; if (s < 0.5) s = 0;
                const kmh = Math.round(s * 3.6);
                document.getElementById('speed').innerText = kmh;
                let now = Date.now();
                let delta = (now - lastTime) / 1000;
                if (s > 0.5) {
                    totalDist += (s * delta) / 1000;
                    document.getElementById('dash-dist').innerText = totalDist.toFixed(1) + " km";
                    speeds.push(kmh);
                    route.push(`${p.coords.latitude},${p.coords.longitude}`);
                    if (!lastLat || Math.abs(p.coords.latitude - lastLat) > 0.0005) {
                        updateRoadData(p.coords.latitude, p.coords.longitude);
                        lastLat = p.coords.latitude;
                    }
                }
                lastTime = now;
                if (kmh > currentLimit) {
                    document.getElementById('slow-overlay').style.display = 'flex';
                    document.body.classList.add('danger'); playAlarm(800);
                    overspeedSec += delta;
                } else {
                    document.getElementById('slow-overlay').style.display = 'none';
                    document.body.classList.remove('danger');
                }
            }, null, { enableHighAccuracy: true });

            timerInterval = setInterval(() => {
                let d = new Date(Date.now() - rideStart);
                document.getElementById('dash-duration').innerText = d.toISOString().substr(11, 8);
            }, 1000);
        }

        function stopRide() {
            navigator.geolocation.clearWatch(watchID);
            clearInterval(timerInterval);
            if (wakeLock) { wakeLock.release(); wakeLock = null; }
            const duration = Math.round((Date.now() - rideStart) / 1000);
            if (speeds.length > 5) {
                const pathStr = route.filter((_,i) => i % 15 === 0).join('/');
                tripHistory.push({
                    dt: new Date().toLocaleDateString('en-GB', {day:'2-digit', month:'short'}),
                    dur: Math.floor(duration / 60) + "m",
                    map: `https://www.google.com/maps/dir/${pathStr}`,
                    dst: totalDist.toFixed(1), mx: Math.max(...speeds, 0), ov: Math.round(overspeedSec / 60)
                });
                localStorage.setItem('SpeedGuardFinalV13', JSON.stringify(tripHistory));
            }
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('startBtn').style.display = 'block';
            document.getElementById('speed').innerText = "0";
            document.getElementById('dash-duration').innerText = "00:00:00";
            document.getElementById('dash-dist').innerText = "0.0 km";
            document.body.classList.remove('danger');
            document.getElementById('slow-overlay').style.display = 'none';
            document.getElementById('gps-status').innerText = "GPS: IDLE | LOCK: AUTO";
            renderLogs();
        }

        function renderLogs() {
            document.getElementById('sum-dist').innerText = tripHistory.reduce((a, b) => a + parseFloat(b.dst), 0).toFixed(1);
            document.getElementById('sum-max').innerText = Math.max(...tripHistory.map(t => t.mx), 0);
            document.getElementById('sum-rides').innerText = tripHistory.length;
            document.getElementById('sum-time').innerText = tripHistory.reduce((a, b) => a + parseInt(b.dur), 0);
            document.getElementById('tripLogs').innerHTML = [...tripHistory].reverse().map(t => `
                <tr><td>${t.dt}</td><td>${t.dur}</td><td>${t.dst}k</td><td>${t.mx}</td>
                <td style="color:${parseInt(t.ov)>0?'red':'inherit'}">${t.ov}m</td>
                <td><a href="${t.map}" target="_blank" style="color:var(--neon-green); font-weight:bold; text-decoration:none;">ROUTE</a></td></tr>
            `).join('');
        }

        function exportCSV() {
            let csv = "Date,Duration,KM,MaxSpeed,OverspeedMin,MapURL\n";
            tripHistory.forEach(t => csv += `${t.dt},${t.dur},${t.dst},${t.mx},${t.ov},"${t.map}"\n`);
            const b = new Blob([csv], {type:'text/csv'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download='SpeedGuard_Logs.csv'; a.click();
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const lines = e.target.result.split('\n').slice(1);
                lines.forEach(line => {
                    const cols = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                    if(cols.length >= 5) tripHistory.push({ dt: cols[0], dur: cols[1], dst: cols[2], mx: cols[3], ov: cols[4], map: cols[5]?.replace(/"/g, '') });
                });
                localStorage.setItem('SpeedGuardFinalV13', JSON.stringify(tripHistory));
                renderLogs();
            };
            reader.readAsText(file);
        }

        function openTab(name) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(name).classList.add('active');
            if (name === 'monitor') document.getElementById('mon-tab').classList.add('active');
            else { document.getElementById('log-tab').classList.add('active'); renderLogs(); }
        }

        window.onload = renderLogs;
    </script>
</body>
</html>
